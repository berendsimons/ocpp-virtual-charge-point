<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Charge Point Dashboard</title>
  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700,900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-cream: #f8f6f1;
      --bg-white: #ffffff;
      --bg-hover: #f5f3ee;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-muted: #9a9a9a;
      --border-light: #e8e5de;
      --border-medium: #d4d0c8;
      --accent-green: #00c853;
      --accent-green-dark: #00a844;
      --accent-green-light: #e8f5e9;
      --accent-blue: #2563eb;
      --accent-blue-light: #e3f2fd;
      --accent-orange: #f59e0b;
      --accent-orange-light: #fff8e1;
      --accent-red: #ef4444;
      --accent-red-light: #fef2f2;
      --accent-purple: #8b5cf6;
      --accent-purple-light: #f3e5f5;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.08);
      --shadow-xl: 0 20px 50px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --nav-width: 240px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Satoshi', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-cream);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .app { display: flex; min-height: 100vh; }

    /* Navigation */
    .nav {
      width: var(--nav-width);
      background: var(--bg-white);
      border-right: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      z-index: 100;
    }
    .nav-header { padding: 24px; border-bottom: 1px solid var(--border-light); }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-dark) 100%);
      border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
    }
    .logo-icon svg { width: 24px; height: 24px; color: white; }
    .logo-text { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
    .logo-text span { color: var(--accent-green); }
    .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; }
    .nav-section { margin-bottom: 24px; }
    .nav-section-title { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; padding: 8px 12px; }
    .nav-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; border-radius: var(--radius-sm);
      color: var(--text-secondary); font-weight: 500; font-size: 14px;
      cursor: pointer; transition: all 0.15s ease; margin-bottom: 4px;
    }
    .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .nav-item.active { background: var(--accent-green-light); color: var(--accent-green-dark); }
    .nav-item svg { width: 20px; height: 20px; flex-shrink: 0; }
    .nav-item-badge { margin-left: auto; background: var(--accent-green); color: white; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 100px; }
    .nav-footer { padding: 16px 24px; border-top: 1px solid var(--border-light); }
    .nav-status { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
    .nav-status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green); animation: pulse 2s ease-in-out infinite; }
    .nav-status-dot.offline { background: var(--accent-red); animation: none; }

    /* Main */
    .main { flex: 1; margin-left: var(--nav-width); min-height: 100vh; }
    .page-header {
      background: var(--bg-white); border-bottom: 1px solid var(--border-light);
      padding: 20px 32px; display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 50;
    }
    .page-title { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
    .page-subtitle { font-size: 14px; color: var(--text-muted); margin-top: 2px; }
    .page-actions { display: flex; gap: 12px; align-items: center; }
    .page-content { padding: 32px; }
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.3s ease; }

    /* Buttons */
    .btn {
      padding: 10px 20px; border: none; border-radius: var(--radius-sm);
      font-family: 'Satoshi', sans-serif; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all 0.15s ease;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary { background: var(--accent-green); color: white; }
    .btn-primary:hover { background: var(--accent-green-dark); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-secondary { background: var(--bg-white); color: var(--text-primary); border: 1px solid var(--border-medium); }
    .btn-secondary:hover { background: var(--bg-hover); }
    .btn-danger { background: var(--accent-red-light); color: var(--accent-red); border: 1px solid #fecaca; }
    .btn-danger:hover { background: #fee2e2; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-icon { padding: 8px 12px; }

    /* Dropdown */
    .dropdown { position: relative; }
    .dropdown-menu {
      position: absolute; top: calc(100% + 8px); right: 0;
      background: var(--bg-white); border: 1px solid var(--border-light);
      border-radius: var(--radius-md); box-shadow: var(--shadow-lg);
      min-width: 200px; z-index: 100; display: none; animation: slideInDown 0.15s ease;
    }
    .dropdown-menu.show { display: block; }
    .dropdown-header { padding: 12px 16px; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-light); }
    .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; font-size: 14px; color: var(--text-primary); cursor: pointer; transition: background 0.1s ease; }
    .dropdown-item:hover { background: var(--bg-hover); }
    .dropdown-item svg { width: 18px; height: 18px; color: var(--text-muted); }
    .dropdown-divider { height: 1px; background: var(--border-light); margin: 8px 0; }

    /* Table */
    .table-container { background: var(--bg-white); border: 1px solid var(--border-light); border-radius: var(--radius-lg); overflow: hidden; }
    .table-toolbar { padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
    .table-toolbar-left { display: flex; gap: 12px; align-items: center; }
    .table-search { position: relative; }
    .table-search input { padding: 8px 12px 8px 36px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-family: 'Satoshi', sans-serif; font-size: 14px; width: 240px; transition: all 0.15s ease; }
    .table-search input:focus { outline: none; border-color: var(--accent-green); }
    .table-search svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted); }
    .selection-info { font-size: 14px; color: var(--text-secondary); padding: 8px 16px; background: var(--accent-green-light); border-radius: var(--radius-sm); display: none; }
    .selection-info.show { display: flex; align-items: center; gap: 12px; }
    .selection-info strong { color: var(--accent-green-dark); }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--bg-cream); }
    th { text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-light); }
    th:first-child { padding-left: 20px; width: 48px; }
    td { padding: 16px; border-bottom: 1px solid var(--border-light); font-size: 14px; }
    td:first-child { padding-left: 20px; }
    tbody tr { cursor: pointer; transition: background 0.1s ease; }
    tbody tr:hover { background: var(--bg-hover); }
    tbody tr:last-child td { border-bottom: none; }
    /* Filter bar */
    .filter-bar { padding: 12px 20px; border-bottom: 1px solid var(--border-light); display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .filter-bar .form-select { width: auto; padding: 6px 10px; font-size: 13px; border-radius: var(--radius-sm); }
    .filter-tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--accent-green-light); color: var(--accent-green-dark); border-radius: 100px; font-size: 12px; font-weight: 600; }
    .filter-tag button { border: none; background: none; color: var(--accent-green-dark); cursor: pointer; font-size: 14px; line-height: 1; padding: 0; font-weight: 700; }
    .filter-tag button:hover { color: var(--accent-red); }
    .filter-count { font-size: 13px; color: var(--text-muted); margin-left: auto; }

    /* Select % popover */
    .select-cell-wrapper { display: flex; align-items: center; gap: 2px; }
    .select-pct-btn { border: none; background: none; cursor: pointer; color: var(--text-muted); padding: 0 2px; font-size: 10px; line-height: 1; display: flex; align-items: center; }
    .select-pct-btn:hover { color: var(--accent-green); }
    .select-pct-popover { position: absolute; top: 100%; left: 0; background: var(--bg-white); border: 1px solid var(--border-light); border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); padding: 12px; z-index: 60; display: none; min-width: 180px; }
    .select-pct-popover.show { display: block; animation: slideInDown 0.15s ease; }
    .select-pct-popover label { font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 6px; }
    .select-pct-row { display: flex; gap: 6px; }
    .select-pct-row input { width: 70px; padding: 6px 8px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-family: 'Satoshi', sans-serif; font-size: 13px; text-align: center; }
    .select-pct-row input:focus { outline: none; border-color: var(--accent-green); }

    .checkbox-cell { width: 48px; }
    input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent-green); cursor: pointer; }
    .charger-id-cell { font-weight: 600; color: var(--text-primary); }
    .copyable { cursor: copy; position: relative; }
    .copyable:hover { color: var(--accent-blue); }
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 100px; font-size: 12px; font-weight: 600; }
    .status-badge.Available { background: var(--accent-green-light); color: var(--accent-green-dark); }
    .status-badge.Charging { background: var(--accent-blue-light); color: var(--accent-blue); }
    .status-badge.Preparing { background: var(--accent-orange-light); color: var(--accent-orange); }
    .status-badge.Finishing { background: var(--accent-purple-light); color: var(--accent-purple); }
    .status-badge.Reserved { background: #fce4ec; color: #c2185b; }
    .status-badge.Unavailable { background: #f5f5f5; color: #757575; }
    .status-badge.Faulted { background: var(--accent-red-light); color: var(--accent-red); }
    .status-badge.SuspendedEV, .status-badge.SuspendedEVSE { background: var(--accent-orange-light); color: var(--accent-orange); }
    .status-badge.offline { background: #f5f5f5; color: #9a9a9a; }
    .status-badge-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .text-muted { color: var(--text-muted); }
    .table-empty { padding: 60px 24px; text-align: center; }
    .table-empty-icon { width: 64px; height: 64px; background: var(--bg-cream); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
    .table-empty-icon svg { width: 32px; height: 32px; color: var(--text-muted); }
    .table-empty h3 { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
    .table-empty p { color: var(--text-muted); margin-bottom: 20px; }

    /* Panel */
    .panel-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 200; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
    .panel-overlay.show { opacity: 1; visibility: visible; }
    .slide-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 560px; max-width: 100%; background: var(--bg-white); box-shadow: var(--shadow-xl); z-index: 201; transform: translateX(100%); transition: transform 0.3s ease; display: flex; flex-direction: column; }
    .slide-panel.show { transform: translateX(0); }
    .panel-header { padding: 24px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: flex-start; }
    .panel-title { font-size: 20px; font-weight: 700; }
    .panel-subtitle { font-size: 14px; color: var(--text-muted); margin-top: 4px; }
    .panel-close { width: 36px; height: 36px; border: none; background: var(--bg-cream); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.15s ease; }
    .panel-close:hover { background: var(--border-light); }
    .panel-close svg { width: 20px; height: 20px; color: var(--text-secondary); }
    .panel-body { flex: 1; overflow-y: auto; padding: 24px; }
    .panel-section { margin-bottom: 32px; }
    .panel-section-title { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .info-item { background: var(--bg-cream); padding: 16px; border-radius: var(--radius-sm); }
    .info-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .info-value { font-size: 16px; font-weight: 600; }
    .connector-card { background: var(--bg-cream); border-radius: var(--radius-md); padding: 20px; margin-bottom: 12px; }
    .connector-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .connector-card-title { font-weight: 600; }
    .connector-card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .connector-stat { background: var(--bg-white); padding: 12px; border-radius: var(--radius-sm); }
    .connector-stat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 2px; }
    .connector-stat-value { font-size: 18px; font-weight: 700; }
    .log-list { max-height: 200px; overflow-y: auto; background: #1a1a1a; border-radius: var(--radius-sm); padding: 16px; font-family: monospace; font-size: 12px; }
    .log-entry { display: flex; gap: 12px; margin-bottom: 8px; color: #e7e9ea; }
    .log-time { color: #6b7280; flex-shrink: 0; }
    .log-type { flex-shrink: 0; font-weight: 600; }
    .log-type.sent { color: #60a5fa; }
    .log-type.recv { color: #34d399; }
    .panel-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .panel-action-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 20px; background: var(--bg-cream); border: 1px solid var(--border-light); border-radius: var(--radius-md); cursor: pointer; transition: all 0.15s ease; }
    .panel-action-btn:hover { background: var(--bg-hover); border-color: var(--border-medium); }
    .panel-action-btn svg { width: 24px; height: 24px; color: var(--text-secondary); }
    .panel-action-btn span { font-size: 13px; font-weight: 600; color: var(--text-primary); }

    /* Forms */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
    .form-input, .form-select { width: 100%; padding: 12px 14px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-family: 'Satoshi', sans-serif; font-size: 14px; color: var(--text-primary); background: var(--bg-white); transition: all 0.15s ease; }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-green); box-shadow: 0 0 0 3px rgba(0, 200, 83, 0.1); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    .slider-control { display: flex; align-items: center; gap: 16px; }
    .slider { flex: 1; height: 8px; -webkit-appearance: none; background: var(--border-light); border-radius: 4px; outline: none; }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--accent-green); cursor: pointer; box-shadow: var(--shadow-sm); }
    .slider-value { min-width: 60px; padding: 8px 12px; background: var(--bg-cream); border-radius: var(--radius-sm); font-weight: 600; text-align: center; font-size: 14px; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 300; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s ease; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--bg-white); border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); width: 560px; max-width: 90%; max-height: 90vh; overflow: hidden; animation: fadeInUp 0.2s ease; }
    .modal-header { padding: 24px; border-bottom: 1px solid var(--border-light); }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-body { padding: 24px; max-height: 60vh; overflow-y: auto; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-light); display: flex; justify-content: flex-end; gap: 12px; }

    /* Settings */
    .settings-section { background: var(--bg-white); border: 1px solid var(--border-light); border-radius: var(--radius-lg); margin-bottom: 24px; }
    .settings-section-header { padding: 20px 24px; border-bottom: 1px solid var(--border-light); }
    .settings-section-title { font-size: 16px; font-weight: 700; }
    .settings-section-desc { font-size: 14px; color: var(--text-muted); margin-top: 4px; }
    .settings-section-body { padding: 24px; }

    /* Stats */
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .stat-card { background: var(--bg-white); border: 1px solid var(--border-light); border-radius: var(--radius-md); padding: 20px; }
    .stat-card-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
    .stat-card-icon.green { background: var(--accent-green-light); color: var(--accent-green); }
    .stat-card-icon.blue { background: var(--accent-blue-light); color: var(--accent-blue); }
    .stat-card-icon.orange { background: var(--accent-orange-light); color: var(--accent-orange); }
    .stat-card-icon.purple { background: var(--accent-purple-light); color: var(--accent-purple); }
    .stat-card-icon svg { width: 20px; height: 20px; }
    .stat-card-value { font-size: 28px; font-weight: 900; letter-spacing: -1px; }
    .stat-card-label { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

    /* Toast */
    .toast { position: fixed; bottom: 32px; right: 32px; padding: 16px 24px; border-radius: var(--radius-md); font-size: 14px; font-weight: 600; z-index: 1000; animation: slideInRight 0.3s ease; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow-lg); }
    .toast.success { background: var(--accent-green); color: white; }
    .toast.error { background: var(--accent-red); color: white; }

    /* Models page */
    .model-card { background: var(--bg-white); border: 1px solid var(--border-light); border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px; cursor: pointer; transition: all 0.15s ease; }
    .model-card:hover { border-color: var(--border-medium); box-shadow: var(--shadow-md); }
    .model-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .model-card-title { font-size: 16px; font-weight: 700; }
    .model-card-vendor { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
    .model-card-badge { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 100px; background: var(--accent-blue-light); color: var(--accent-blue); }
    .model-card-details { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light); }
    .model-card-detail { }
    .model-card-detail-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .model-card-detail-value { font-size: 13px; font-weight: 600; margin-top: 2px; }
    .model-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }

    /* Tabs for models */
    .tabs { display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid var(--border-light); }
    .tab { padding: 12px 20px; border: none; background: none; font-family: 'Satoshi', sans-serif; font-size: 14px; font-weight: 600; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.15s ease; }
    .tab:hover { color: var(--text-primary); }
    .tab.active { color: var(--accent-green-dark); border-bottom-color: var(--accent-green); }

    .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: var(--bg-cream); color: var(--text-secondary); margin-right: 4px; }

    /* Sortable table */
    th.sortable { cursor: pointer; user-select: none; transition: background 0.1s ease; }
    th.sortable:hover { background: var(--bg-hover); }
    .sort-icon { display: inline-block; width: 16px; height: 16px; vertical-align: middle; margin-left: 4px; opacity: 0.3; }
    .sort-icon::after { content: '↕'; font-size: 12px; }
    .sort-icon.asc::after { content: '↑'; opacity: 1; }
    .sort-icon.desc::after { content: '↓'; opacity: 1; }
    .sort-icon.asc, .sort-icon.desc { opacity: 1; color: var(--accent-green); }
    .id-pattern { font-family: monospace; font-size: 13px; background: var(--bg-cream); padding: 4px 8px; border-radius: 4px; }
    .action-btn { padding: 6px 10px; border: none; background: var(--bg-cream); border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; font-weight: 600; color: var(--text-secondary); transition: all 0.15s ease; }
    .action-btn:hover { background: var(--border-light); color: var(--text-primary); }
    .action-btn.primary { background: var(--accent-green-light); color: var(--accent-green-dark); }
    .action-btn.primary:hover { background: var(--accent-green); color: white; }

    /* EV Simulator styles */
    .ev-tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 100px; font-size: 11px; font-weight: 700; background: var(--accent-purple-light); color: var(--accent-purple); margin-left: 6px; }
    .soc-bar-container { width: 100%; height: 8px; background: var(--border-light); border-radius: 4px; overflow: hidden; margin-top: 6px; }
    .soc-bar { height: 100%; border-radius: 4px; transition: width 0.5s ease, background 0.5s ease; }
    .soc-bar.low { background: var(--accent-red); }
    .soc-bar.mid { background: var(--accent-orange); }
    .soc-bar.high { background: var(--accent-green); }
    .car-info-card { background: var(--accent-purple-light); border: 1px solid #d1c4e9; border-radius: var(--radius-sm); padding: 14px; margin-top: 12px; }
    .car-info-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .car-info-card-name { font-weight: 700; font-size: 14px; color: var(--accent-purple); }
    .car-info-card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .car-info-stat { background: rgba(255,255,255,0.7); padding: 8px; border-radius: 6px; }
    .car-info-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .car-info-stat-value { font-size: 15px; font-weight: 700; margin-top: 2px; }
    .plug-car-btn { display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; padding: 10px; margin-top: 12px; border: 2px dashed var(--border-medium); border-radius: var(--radius-sm); background: transparent; font-family: 'Satoshi', sans-serif; font-size: 13px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.15s ease; }
    .plug-car-btn:hover { border-color: var(--accent-purple); color: var(--accent-purple); background: var(--accent-purple-light); }
    .unplug-btn { padding: 4px 10px; border: none; border-radius: 6px; background: var(--accent-red-light); color: var(--accent-red); font-size: 11px; font-weight: 600; cursor: pointer; font-family: 'Satoshi', sans-serif; }
    .unplug-btn:hover { background: #fee2e2; }
    .soc-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .soc-label { font-size: 11px; color: var(--text-muted); }
    .soc-percent { font-size: 14px; font-weight: 700; }
    .estimate-text { font-size: 12px; color: var(--text-muted); margin-top: 12px; padding: 10px; background: var(--bg-cream); border-radius: var(--radius-sm); }
  </style>
</head>
<body>
  <div class="app">
    <nav class="nav">
      <div class="nav-header">
        <div class="logo">
          <div class="logo-icon">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
          </div>
          <div class="logo-text">Virtual<span>CP</span></div>
        </div>
      </div>
      <div class="nav-menu">
        <div class="nav-section">
          <div class="nav-section-title">Menu</div>
          <div class="nav-item active" onclick="showPage('chargers')">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
            Chargers
            <span class="nav-item-badge" id="chargerCountBadge">0</span>
          </div>
          <div class="nav-item" onclick="showPage('locations')">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            Locations
            <span class="nav-item-badge" id="locationCountBadge">0</span>
          </div>
          <div class="nav-item" onclick="showPage('models')">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
            Models
            <span class="nav-item-badge" id="modelCountBadge">0</span>
          </div>
          <div class="nav-item" onclick="showPage('settings')">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            Settings
          </div>
        </div>
      </div>
      <div class="nav-footer">
        <div class="nav-status">
          <span class="nav-status-dot" id="navStatusDot"></span>
          <span id="navStatusText">Connecting...</span>
        </div>
      </div>
    </nav>

    <main class="main">
      <!-- Chargers Page -->
      <div id="page-chargers" class="page active">
        <div class="page-header">
          <div>
            <h1 class="page-title">Chargers</h1>
            <p class="page-subtitle">Manage your virtual charge points</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary" onclick="showAddChargerModal()">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
              Add Charger
            </button>
            <button class="btn btn-secondary" onclick="connectAll()">Connect All</button>
            <button class="btn btn-secondary" onclick="disconnectAll()">Disconnect All</button>
            <div class="dropdown">
              <button class="btn btn-primary btn-icon" onclick="toggleActionsDropdown()">
                Actions
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
              </button>
              <div class="dropdown-menu" id="actionsDropdown">
                <div class="dropdown-header">Apply to selected</div>
                <div class="dropdown-item" onclick="bulkAction('hardReset')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                  Hard Reset
                </div>
                <div class="dropdown-item" onclick="bulkAction('startTransaction')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  Start Transaction
                </div>
                <div class="dropdown-item" onclick="bulkAction('stopTransaction')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" /></svg>
                  Stop Transaction
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-item" onclick="bulkAction('setMaxCurrent')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                  Set Max. Current
                </div>
                <div class="dropdown-item" onclick="bulkAction('changeConfiguration')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                  Change Configuration
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-item" onclick="bulkAction('connect')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                  Connect
                </div>
                <div class="dropdown-item" onclick="bulkAction('disconnect')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                  Disconnect
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-item" onclick="bulkAction('attachLocation')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                  Attach to Location
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-item" onclick="bulkAction('exportCsv')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                  Export CSV
                </div>
                <div class="dropdown-item" onclick="bulkAction('exportIds')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                  Export Charger IDs
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-item" style="color: var(--accent-red);" onclick="bulkAction('delete')">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                  Delete
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="page-content">
          <div class="stats-row">
            <div class="stat-card"><div class="stat-card-icon green"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg></div><div class="stat-card-value" id="statTotal">0</div><div class="stat-card-label">Total Chargers</div></div>
            <div class="stat-card"><div class="stat-card-icon blue"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M13 12a1 1 0 11-2 0 1 1 0 012 0z" /></svg></div><div class="stat-card-value" id="statConnected">0</div><div class="stat-card-label">Connected</div></div>
            <div class="stat-card"><div class="stat-card-icon orange"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg></div><div class="stat-card-value" id="statCharging">0</div><div class="stat-card-label">Charging</div></div>
            <div class="stat-card"><div class="stat-card-icon purple"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></div><div class="stat-card-value" id="statPower">0 kW</div><div class="stat-card-label">Total Power</div></div>
          </div>
          <div class="table-container">
            <div class="table-toolbar">
              <div class="table-toolbar-left">
                <div class="table-search">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                  <input type="text" placeholder="Search chargers..." id="searchInput" oninput="filterChargers()">
                </div>
                <div class="selection-info" id="selectionInfo"><strong id="selectedCount">0</strong> selected <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Clear</button></div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;">
                <button class="btn btn-sm btn-secondary" onclick="showGenerateModal()">Generate Multiple</button>
              </div>
            </div>
            <div class="filter-bar" id="filterBar">
              <select class="form-select" id="filterVendor" onchange="filterChargers()"><option value="">All Vendors</option></select>
              <select class="form-select" id="filterModel" onchange="filterChargers()"><option value="">All Models</option></select>
              <select class="form-select" id="filterInstall" onchange="filterChargers()">
                <option value="">All Install</option>
                <option value="1">1-phase</option>
                <option value="3">3-phase</option>
              </select>
              <select class="form-select" id="filterConnectors" onchange="filterChargers()">
                <option value="">All # Conn.</option>
                <option value="1">1 connector</option>
                <option value="2">2 connectors</option>
                <option value="3">3 connectors</option>
              </select>
              <select class="form-select" id="filterConnection" onchange="filterChargers()">
                <option value="">All Connection</option>
                <option value="connected">Connected</option>
                <option value="disconnected">Disconnected</option>
              </select>
              <select class="form-select" id="filterConnectorStatus" onchange="filterChargers()">
                <option value="">All Connector Status</option>
                <option value="Available">Available</option>
                <option value="Preparing">Preparing</option>
                <option value="Charging">Charging</option>
                <option value="SuspendedEV">SuspendedEV</option>
                <option value="SuspendedEVSE">SuspendedEVSE</option>
                <option value="Finishing">Finishing</option>
                <option value="Reserved">Reserved</option>
                <option value="Unavailable">Unavailable</option>
                <option value="Faulted">Faulted</option>
              </select>
              <select class="form-select" id="filterLocation" onchange="filterChargers()">
                <option value="">All Locations</option>
                <option value="attached">Has location</option>
                <option value="unattached">No location</option>
              </select>
              <button class="btn btn-sm btn-secondary" onclick="resetFilters()">Reset</button>
              <span class="filter-count" id="filterCount"></span>
            </div>
            <table>
              <thead><tr>
                <th class="checkbox-cell" style="position:relative;">
                  <div class="select-cell-wrapper">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    <button class="select-pct-btn" onclick="event.stopPropagation(); toggleSelectPctPopover();" title="Select random %">&#9662;</button>
                  </div>
                  <div class="select-pct-popover" id="selectPctPopover">
                    <label>Select random %</label>
                    <div class="select-pct-row">
                      <input type="number" id="selectPctInput" min="0" max="100" value="50" placeholder="%" onkeydown="if(event.key==='Enter'){selectRandomPercent();event.preventDefault();}">
                      <button class="btn btn-sm btn-primary" onclick="selectRandomPercent()">Select</button>
                    </div>
                  </div>
                </th>
                <th>Chargepoint ID</th><th>Location</th><th>Conn. 0</th><th>Conn. 1</th><th>Conn. 2</th><th>Vendor</th><th>Model</th><th>Install</th>
              </tr></thead>
              <tbody id="chargersTableBody"></tbody>
            </table>
            <div class="table-empty" id="tableEmpty" style="display: none;">
              <div class="table-empty-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg></div>
              <h3>No chargers yet</h3>
              <p>Add your first virtual charge point to get started</p>
              <button class="btn btn-primary" onclick="showAddChargerModal()">Add Charger</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Models Page -->
      <div id="page-models" class="page">
        <div class="page-header">
          <div>
            <h1 class="page-title">Models</h1>
            <p class="page-subtitle">Configure charger templates for generation</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="showAddModelModal()">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
              Add Model
            </button>
          </div>
        </div>
        <div class="page-content">
          <div class="table-container">
            <div class="table-toolbar">
              <div class="table-toolbar-left">
                <div class="table-search">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                  <input type="text" placeholder="Search models..." id="modelSearchInput" oninput="filterModels()">
                </div>
                <select class="form-select" id="modelVendorFilter" onchange="filterModels()" style="width: 180px; padding: 8px 12px;">
                  <option value="">All Vendors</option>
                </select>
                <select class="form-select" id="modelMeterFilter" onchange="filterModels()" style="width: 140px; padding: 8px 12px;">
                  <option value="">All Meters</option>
                  <option value="MID">MID</option>
                  <option value="Internal">Internal</option>
                </select>
              </div>
              <div style="font-size: 13px; color: var(--text-muted);"><span id="modelFilterCount">0</span> models</div>
            </div>
            <table id="modelsTable">
              <thead>
                <tr>
                  <th class="sortable" onclick="sortModels('name')">Model <span class="sort-icon" data-col="name"></span></th>
                  <th class="sortable" onclick="sortModels('vendor')">Vendor <span class="sort-icon" data-col="vendor"></span></th>
                  <th class="sortable" onclick="sortModels('connectors')">Connectors <span class="sort-icon" data-col="connectors"></span></th>
                  <th>Firmware</th>
                  <th class="sortable" onclick="sortModels('meterType')">Meter <span class="sort-icon" data-col="meterType"></span></th>
                  <th>ID Pattern</th>
                  <th class="sortable" onclick="sortModels('idLength')">ID Length <span class="sort-icon" data-col="idLength"></span></th>
                  <th style="width: 100px;">Actions</th>
                </tr>
              </thead>
              <tbody id="modelsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Locations Page -->
      <div id="page-locations" class="page">
        <div class="page-header">
          <div>
            <h1 class="page-title">Locations</h1>
            <p class="page-subtitle">Manage Plugchoice sites</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary" onclick="showGenerateLocationsModal()">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
              Generate Locations
            </button>
            <button class="btn btn-primary" onclick="loadLocations()">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
              Refresh
            </button>
          </div>
        </div>
        <div class="page-content">
          <div id="locationsTokenWarning" style="display:none; padding: 20px; background: var(--accent-orange-light); border: 1px solid var(--accent-orange); border-radius: var(--radius-md); margin-bottom: 20px; font-size: 14px;">
            No Plugchoice API token configured. Go to <a href="#" onclick="showPage('settings'); return false;" style="color: var(--accent-blue); font-weight: 600;">Settings</a> to add your token.
          </div>
          <div class="table-container">
            <div class="table-toolbar">
              <div class="table-toolbar-left">
                <div class="table-search">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                  <input type="text" placeholder="Search locations..." id="locationSearchInput" oninput="renderLocations()">
                </div>
              </div>
              <span class="filter-count" id="locationFilterCount"></span>
            </div>
            <div class="filter-bar" id="locationFilterBar">
              <select class="form-select" id="filterLocCity" onchange="renderLocations()"><option value="">All Cities</option></select>
              <select class="form-select" id="filterLocChargers" onchange="renderLocations()">
                <option value="">All Charger Counts</option>
                <option value="0">0 chargers</option>
                <option value="1-5">1–5 chargers</option>
                <option value="6+">6+ chargers</option>
              </select>
              <button class="action-btn" onclick="resetLocationFilters()" style="font-size:12px;">Reset</button>
            </div>
            <table id="locationsTable">
              <thead><tr>
                <th class="sortable" onclick="sortLocations('name')">Name <span class="sort-icon loc-sort-icon" data-col="name"></span></th>
                <th class="sortable" onclick="sortLocations('street')">Street <span class="sort-icon loc-sort-icon" data-col="street"></span></th>
                <th class="sortable" onclick="sortLocations('house_number')">Nr <span class="sort-icon loc-sort-icon" data-col="house_number"></span></th>
                <th class="sortable" onclick="sortLocations('postal_code')">Postal Code <span class="sort-icon loc-sort-icon" data-col="postal_code"></span></th>
                <th class="sortable" onclick="sortLocations('city')">City <span class="sort-icon loc-sort-icon" data-col="city"></span></th>
                <th class="sortable" onclick="sortLocations('chargers_count')">Chargers <span class="sort-icon loc-sort-icon" data-col="chargers_count"></span></th>
                <th style="width:80px;">Actions</th>
              </tr></thead>
              <tbody id="locationsTableBody"></tbody>
            </table>
            <div class="table-empty" id="locationsTableEmpty" style="display: none;">
              <div class="table-empty-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div>
              <h3>No locations yet</h3>
              <p>Generate locations or configure your Plugchoice API token</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Location Detail Page -->
      <div id="page-location-detail" class="page">
        <div class="page-header">
          <div style="display: flex; align-items: center; gap: 16px;">
            <button class="btn btn-secondary" onclick="showPage('locations')" title="Back to Locations" style="padding: 8px 10px; min-width: 0;">
              <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
            </button>
            <div>
              <h1 class="page-title" id="locDetailName">Location</h1>
              <p class="page-subtitle" id="locDetailAddress">Address</p>
            </div>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="refreshLocationDetail()">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
              Refresh
            </button>
          </div>
        </div>
        <div class="page-content">
          <!-- Overview Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px;" id="locDetailOverview"></div>

          <!-- Chargers Table -->
          <div class="table-container" style="margin-bottom: 24px;">
            <div class="table-toolbar">
              <div class="table-toolbar-left">
                <span style="font-weight: 700; font-size: 16px;">Chargers</span>
              </div>
              <span class="filter-count" id="locDetailChargerCount"></span>
            </div>
            <table>
              <thead><tr>
                <th>Identity</th><th>Status</th><th>Firmware</th><th>Last Seen</th>
              </tr></thead>
              <tbody id="locDetailChargersBody"></tbody>
            </table>
            <div class="table-empty" id="locDetailChargersEmpty" style="display: none;">
              <div class="table-empty-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg></div>
              <h3>No chargers assigned</h3>
              <p>Attach chargers to this location from the Chargers page</p>
            </div>
          </div>

          <!-- Cards Table -->
          <div class="table-container">
            <div class="table-toolbar">
              <div class="table-toolbar-left">
                <span style="font-weight: 700; font-size: 16px;">RFID Cards</span>
              </div>
              <span class="filter-count" id="locDetailCardCount"></span>
            </div>
            <table>
              <thead><tr>
                <th>Name</th><th>UID (id_token)</th><th>Created</th>
              </tr></thead>
              <tbody id="locDetailCardsBody"></tbody>
            </table>
            <div class="table-empty" id="locDetailCardsEmpty" style="display: none;">
              <div class="table-empty-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75v10.5A2.25 2.25 0 004.5 19.5zm6-10.125a1.875 1.875 0 11-3.75 0 1.875 1.875 0 013.75 0z" /></svg></div>
              <h3>No cards</h3>
              <p>Cards are generated automatically when creating locations</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="page-settings" class="page">
        <div class="page-header">
          <div>
            <h1 class="page-title">Settings</h1>
            <p class="page-subtitle">Configure your dashboard and connections</p>
          </div>
        </div>
        <div class="page-content">
          <div class="settings-section">
            <div class="settings-section-header">
              <h2 class="settings-section-title">WebSocket Connection</h2>
              <p class="settings-section-desc">Configure the OCPP Central System URL</p>
            </div>
            <div class="settings-section-body">
              <div class="form-group">
                <label class="form-label">WebSocket URL</label>
                <div style="display: flex; gap: 12px;">
                  <input type="text" class="form-input" id="wsUrlInput" placeholder="ws://localhost:3000" style="flex: 1;">
                  <button class="btn btn-primary" onclick="saveWsUrl()">Save</button>
                </div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-header">
              <h2 class="settings-section-title">Plugchoice API</h2>
              <p class="settings-section-desc">Connect to the Plugchoice platform to manage locations and charger assignments</p>
            </div>
            <div class="settings-section-body">
              <div class="form-group">
                <label class="form-label">API Token</label>
                <div style="display: flex; gap: 12px;">
                  <input type="password" class="form-input" id="plugchoiceTokenInput" placeholder="Paste your Plugchoice API token..." style="flex: 1;">
                  <button class="btn btn-primary" onclick="savePlugchoiceToken()">Save</button>
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 6px;" id="plugchoiceTokenStatus">Checking...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Charger Detail Panel -->
  <div class="panel-overlay" id="panelOverlay" onclick="closeChargerPanel()"></div>
  <div class="slide-panel" id="chargerPanel">
    <div class="panel-header">
      <div><h2 class="panel-title copyable" id="panelChargerTitle" onclick="copyToClipboard(this.textContent, event)" title="Click to copy">Charger</h2><p class="panel-subtitle" id="panelChargerSubtitle">VirtualCharger VCP-1</p></div>
      <button class="panel-close" onclick="closeChargerPanel()"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
    </div>
    <div class="panel-body">
      <div class="panel-section">
        <div class="panel-section-title">Quick Actions</div>
        <div class="panel-actions">
          <div class="panel-action-btn" onclick="chargerAction('connect')"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg><span>Connect</span></div>
          <div class="panel-action-btn" onclick="chargerAction('hardReset')"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg><span>Hard Reset</span></div>
          <div class="panel-action-btn" onclick="chargerAction('startTransaction')"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Start Transaction</span></div>
          <div class="panel-action-btn" onclick="chargerAction('stopTransaction')"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" /></svg><span>Stop Transaction</span></div>
        </div>
      </div>
      <div class="panel-section">
        <div class="panel-section-title">Information</div>
        <div class="info-grid">
          <div class="info-item"><div class="info-label">Status</div><div class="info-value" id="panelStatus">Offline</div></div>
          <div class="info-item"><div class="info-label">Serial Number</div><div class="info-value" id="panelSerial">-</div></div>
          <div class="info-item"><div class="info-label">Firmware</div><div class="info-value" id="panelFirmware">-</div></div>
          <div class="info-item"><div class="info-label">Installation</div><div class="info-value" id="panelMaxCurrent">3-phase</div></div>
        </div>
      </div>
      <div class="panel-section">
        <div class="panel-section-title">Connectors</div>
        <div id="panelConnectors"></div>
      </div>
      <div class="panel-section">
        <div class="panel-section-title" id="panelCurrentLabel">Charging Current</div>
        <div class="form-group">
          <div class="slider-control">
            <input type="range" class="slider" id="panelCurrentSlider" min="0" max="32" value="16" oninput="updatePanelCurrent()">
            <span class="slider-value" id="panelCurrentValue">16 A</span>
          </div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="applyPanelCurrent()">Apply Current</button>
      </div>
      <div class="panel-section">
        <button class="btn btn-danger" onclick="deleteCurrentCharger()" style="width: 100%;">Delete Charger</button>
      </div>
    </div>
  </div>

  <!-- Add Charger Modal -->
  <div class="modal-overlay" id="addChargerModal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Add New Charger</h3></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Use Model Template</label>
          <select class="form-select" id="addChargerModel" onchange="onModelSelectChange()">
            <option value="">-- Custom (no template) --</option>
          </select>
        </div>
        <div id="customChargerFields">
          <div class="form-group">
            <label class="form-label">Charge Point ID *</label>
            <input type="text" class="form-input" id="addCpId" placeholder="e.g., CHARGER-001">
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Vendor</label><input type="text" class="form-input" id="addVendor" value="VirtualCharger"></div>
            <div class="form-group"><label class="form-label">Model</label><input type="text" class="form-input" id="addModel" value="VCP-1"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Serial Number</label><input type="text" class="form-input" id="addSerial" placeholder="Auto-generated"></div>
            <div class="form-group"><label class="form-label">Connectors</label><input type="number" class="form-input" id="addConnectors" value="2" min="1" max="10"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Firmware Version</label><input type="text" class="form-input" id="addFirmware" value="1.0.0"></div>
            <div class="form-group"><label class="form-label">Meter Type</label>
              <select class="form-select" id="addMeterType"><option value="Internal">Internal</option><option value="MID">MID</option></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Installation Phases</label>
              <select class="form-select" id="addPhases">
                <option value="3">3-phase (L1+L2+L3+N)</option>
                <option value="1">1-phase (L1+N)</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddChargerModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addCharger()">Add Charger</button>
      </div>
    </div>
  </div>

  <!-- Generate Modal -->
  <div class="modal-overlay" id="generateModal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Generate Multiple Chargers</h3></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Select Model *</label>
          <select class="form-select" id="genModelSelect" onchange="onGenModelSelectChange()">
            <option value="">-- Select a model --</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Count *</label>
          <input type="number" class="form-input" id="genCount" value="10" min="1" max="100">
        </div>
        <div class="form-group">
          <label class="form-label">Installation Phases</label>
          <select class="form-select" id="genPhases">
            <option value="3">3-phase (L1+L2+L3+N)</option>
            <option value="1">1-phase (L1+N)</option>
          </select>
        </div>
        <div id="genPreview" style="margin-top: 16px; padding: 16px; background: var(--bg-cream); border-radius: var(--radius-sm); display: none;">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Example IDs that will be generated:</div>
          <div id="genPreviewIds" style="font-family: monospace; font-size: 13px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeGenerateModal()">Cancel</button>
        <button class="btn btn-primary" onclick="generateChargers()">Generate</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Model Modal -->
  <div class="modal-overlay" id="modelModal">
    <div class="modal" style="width: 640px;">
      <div class="modal-header"><h3 class="modal-title" id="modelModalTitle">Add Model</h3></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label class="form-label">Model Name *</label><input type="text" class="form-input" id="modelName" placeholder="e.g., Zaptec Go"></div>
          <div class="form-group"><label class="form-label">Vendor *</label><input type="text" class="form-input" id="modelVendor" placeholder="e.g., Zaptec"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Connectors</label><input type="number" class="form-input" id="modelConnectors" value="1" min="1" max="10"></div>
          <div class="form-group"><label class="form-label">Firmware Version</label><input type="text" class="form-input" id="modelFirmware" placeholder="e.g., 3.1.0.2"></div>
        </div>
        <div class="form-group"><label class="form-label">Meter Type</label>
          <select class="form-select" id="modelMeterType"><option value="Internal">Internal</option><option value="MID">MID</option></select>
        </div>
        <hr style="border: none; border-top: 1px solid var(--border-light); margin: 24px 0;">
        <h4 style="font-size: 14px; font-weight: 700; margin-bottom: 16px;">Charge Point ID Generation Rules</h4>
        <div class="form-row-3">
          <div class="form-group"><label class="form-label">ID Prefix</label><input type="text" class="form-input" id="modelPrefix" placeholder="e.g., ZAG-"></div>
          <div class="form-group"><label class="form-label">ID Suffix</label><input type="text" class="form-input" id="modelSuffix" placeholder="e.g., --D"></div>
          <div class="form-group"><label class="form-label">Random Length</label><input type="number" class="form-input" id="modelIdLength" value="8" min="1" max="20"></div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Include Numbers</label>
            <select class="form-select" id="modelIncludeNumbers"><option value="y">Yes</option><option value="n">No</option></select>
          </div>
          <div class="form-group">
            <label class="form-label">Include Letters</label>
            <select class="form-select" id="modelIncludeLetters"><option value="n">No</option><option value="y">Yes (uppercase)</option></select>
          </div>
        </div>
        <div style="margin-top: 16px; padding: 16px; background: var(--bg-cream); border-radius: var(--radius-sm);">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Preview:</div>
          <div id="modelIdPreview" style="font-family: monospace; font-size: 14px; font-weight: 600;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="deleteModelBtn" onclick="deleteModel()" style="margin-right: auto; display: none;">Delete</button>
        <button class="btn btn-secondary" onclick="closeModelModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveModel()">Save Model</button>
      </div>
    </div>
  </div>

  <!-- Bulk Action Modals -->
  <div class="modal-overlay" id="maxCurrentModal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Set Max. Current</h3></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Maximum Current (A)</label>
          <div class="slider-control">
            <input type="range" class="slider" id="bulkCurrentSlider" min="0" max="32" value="32" oninput="document.getElementById('bulkCurrentValue').textContent = this.value + ' A'">
            <span class="slider-value" id="bulkCurrentValue">32 A</span>
          </div>
        </div>
        <p style="font-size: 13px; color: var(--text-muted);">This will apply to <strong id="maxCurrentCount">0</strong> selected charger(s).</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeMaxCurrentModal()">Cancel</button>
        <button class="btn btn-primary" onclick="applyMaxCurrent()">Apply</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="configModal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Change Configuration</h3></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Configuration Key</label>
          <select class="form-select" id="configKey">
            <option value="HeartbeatInterval">HeartbeatInterval</option>
            <option value="MeterValueSampleInterval">MeterValueSampleInterval</option>
            <option value="ConnectionTimeOut">ConnectionTimeOut</option>
            <option value="ClockAlignedDataInterval">ClockAlignedDataInterval</option>
            <option value="MeterValuesSampledData">MeterValuesSampledData</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Value</label><input type="text" class="form-input" id="configValue" placeholder="e.g., 60"></div>
        <p style="font-size: 13px; color: var(--text-muted);">This will apply to <strong id="configCount">0</strong> selected charger(s).</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeConfigModal()">Cancel</button>
        <button class="btn btn-primary" onclick="applyConfig()">Send Configuration</button>
      </div>
    </div>
  </div>

  <!-- Plug In EV Modal -->
  <div class="modal-overlay" id="plugCarModal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Plug In EV</h3></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Car Profile</label>
          <select class="form-select" id="plugCarProfile" onchange="updatePlugCarPreview()">
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Initial State of Charge</label>
          <div class="slider-control">
            <input type="range" class="slider" id="plugCarSoc" min="0" max="99" value="20" oninput="updatePlugCarPreview()">
            <span class="slider-value" id="plugCarSocValue">20%</span>
          </div>
        </div>
        <div class="estimate-text" id="plugCarEstimate"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePlugCarModal()">Cancel</button>
        <button class="btn btn-primary" onclick="plugInCar()">Plug In</button>
      </div>
    </div>
  </div>

  <!-- Attach to Location Modal -->
  <div class="modal-overlay" id="attachLocationModal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Attach to Location</h3></div>
      <div class="modal-body">
        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">Attach <strong id="attachLocationCount">0</strong> selected charger(s) to a location.</p>
        <div class="form-group">
          <label class="form-label">Location</label>
          <div style="position: relative;" id="attachLocSearchWrap">
            <input type="text" class="form-input" id="attachLocSearchInput" placeholder="Search locations..." autocomplete="off"
              oninput="filterAttachLocList()" onfocus="showAttachLocDropdown()">
            <input type="hidden" id="attachLocationSelect" value="_random">
            <div id="attachLocDropdown" style="display:none; position:absolute; top:100%; left:0; right:0; z-index:100; max-height:220px; overflow-y:auto; background:var(--bg-primary); border:1px solid var(--border-light); border-top:none; border-radius:0 0 var(--radius-md) var(--radius-md); box-shadow:0 4px 12px rgba(0,0,0,0.15);">
            </div>
          </div>
          <div id="attachLocSelected" style="margin-top:8px; font-size:13px; color:var(--accent-green); font-weight:600;">Random locations</div>
        </div>
        <div id="attachLocationProgress" style="display:none; margin-top: 16px;">
          <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;" id="attachLocationProgressText">Attaching...</div>
          <div style="width: 100%; height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden;">
            <div id="attachLocationProgressBar" style="width: 0%; height: 100%; background: var(--accent-green); transition: width 0.3s ease; border-radius: 3px;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAttachLocationModal()">Cancel</button>
        <button class="btn btn-primary" id="attachLocationBtn" onclick="executeAttachLocation()">Attach</button>
      </div>
    </div>
  </div>

  <!-- Generate Locations Modal -->
  <div class="modal-overlay" id="generateLocationsModal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Generate Locations</h3></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Number of locations</label>
          <input type="number" class="form-input" id="generateLocationsCount" value="10" min="1" max="100">
        </div>
        <div id="genLocProgress" style="display:none; margin-top: 16px;">
          <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;" id="genLocProgressText">Generating...</div>
          <div style="width: 100%; height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden;">
            <div id="genLocProgressBar" style="width: 0%; height: 100%; background: var(--accent-green); transition: width 0.3s ease; border-radius: 3px;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeGenerateLocationsModal()">Cancel</button>
        <button class="btn btn-primary" id="genLocBtn" onclick="executeGenerateLocations()">Generate</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let chargers = [];
    let selectedChargers = new Set();
    let currentCharger = null;
    let editingModelId = null;
    let refreshInterval;

    // Predefined models from your CSV
    const defaultModels = [
      { id: 'md-terra-d', name: 'MD_TERRA_D', vendor: 'ABB', connectors: 2, firmware: '4.0.4.22', meterType: 'MID', prefix: 'T184', suffix: '--D', idLength: 10, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'md-terra-53', name: 'MD_TERRA_53', vendor: 'ABB', connectors: 2, firmware: '1.3.3.33', meterType: 'MID', prefix: 'T184', suffix: '--D', idLength: 10, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'aura', name: 'AURA', vendor: 'ChargeAmps', connectors: 2, firmware: '147', meterType: 'MID', prefix: '', suffix: '--D', idLength: 12, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'halo', name: 'HALO', vendor: 'ChargeAmps', connectors: 1, firmware: '145', meterType: 'MID', prefix: '', suffix: '--D', idLength: 12, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'ng920-61001', name: 'NG920-61001', vendor: 'Alfen', connectors: 1, firmware: '7.2.9-4297', meterType: 'MID', prefix: 'LIB-', suffix: '--D', idLength: 7, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'ng920-61021', name: 'NG920-61021', vendor: 'Alfen', connectors: 2, firmware: '7.3.0-4377', meterType: 'MID', prefix: 'LIB-', suffix: '--D', idLength: 7, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'ng910-60003', name: 'NG910-60003', vendor: 'Alfen', connectors: 1, firmware: '7.3.1-4320', meterType: 'MID', prefix: 'LIB-', suffix: '--D', idLength: 7, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'zaptec-go', name: 'Zaptec Go', vendor: 'Zaptec', connectors: 1, firmware: '3.1.0.2', meterType: 'Internal', prefix: 'ZAG-', suffix: '--D', idLength: 8, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'zaptec-go2', name: 'Zaptec Go2', vendor: 'Zaptec', connectors: 1, firmware: '2.6.0.6', meterType: 'MID', prefix: 'ZAG-', suffix: '--D', idLength: 8, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'zaptec-pro', name: 'ZAPTEC PRO', vendor: 'Zaptec', connectors: 1, firmware: '2.6.1.0', meterType: 'MID', prefix: 'ZAG-', suffix: '--D', idLength: 8, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'peblar-business', name: 'Business', vendor: 'Peblar', connectors: 1, firmware: '2.5', meterType: 'MID', prefix: 'PEB-', suffix: '--D', idLength: 8, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'peblar-home', name: 'Home', vendor: 'Peblar', connectors: 1, firmware: '2.7', meterType: 'Internal', prefix: 'PEB-', suffix: '--D', idLength: 8, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'wallbox-pulsar', name: 'Pulsar', vendor: 'Wallbox', connectors: 1, firmware: '9.5', meterType: 'Internal', prefix: '', suffix: '--D', idLength: 12, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'wallbox-pulsar-plus', name: 'Pulsar Plus', vendor: 'Wallbox', connectors: 1, firmware: '10.11', meterType: 'Internal', prefix: '', suffix: '--D', idLength: 12, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'ratio-io6', name: 'io6', vendor: 'Ratio', connectors: 2, firmware: '0.9.1', meterType: 'Internal', prefix: 'RATIO_', suffix: '--D', idLength: 10, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'ratio-io7', name: 'io7', vendor: 'Ratio', connectors: 2, firmware: '1.5.2', meterType: 'MID', prefix: 'RATIO_', suffix: '--D', idLength: 10, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'volttime-source2s', name: 'Source 2s', vendor: 'Volt Time', connectors: 1, firmware: 'V1.2@bd02daf+124,F30.G2+,STM32@V2.1.55', meterType: 'MID', prefix: 'VT_', suffix: '--D', idLength: 7, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'volttime-one', name: 'One', vendor: 'Volt Time', connectors: 1, firmware: 'V00.10.02', meterType: 'Internal', prefix: 'VT_', suffix: '--D', idLength: 7, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'smappee-evw', name: 'EVW-332-C8R-E-B', vendor: 'Smappee', connectors: 1, firmware: 'OCPPJ 1.36.0', meterType: 'MID', prefix: 'SMP_', suffix: '--D', idLength: 15, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'smappee-evb', name: 'EVB-2332-C5-E', vendor: 'Smappee', connectors: 2, firmware: 'OCPPJ 1.37.0', meterType: 'MID', prefix: 'SMP_', suffix: '--D', idLength: 15, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'rolec-v1', name: 'V1', vendor: 'Rolec', connectors: 2, firmware: '0.5.2', meterType: 'Internal', prefix: 'Rolec_DKC', suffix: '--D', idLength: 6, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'autel-maxi', name: 'MaxiChargerAC', vendor: 'Autel', connectors: 1, firmware: 'PFA0102|V0.00.00|V1.36.00|V1.22.00|2.4.3.0', meterType: 'Internal', prefix: 'AL00', suffix: '--D', idLength: 14, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'schneider-pro', name: 'SE Charge Pro', vendor: 'Schneider Electric', connectors: 1, firmware: '1.6.1', meterType: 'MID', prefix: 'SN', suffix: '--D', idLength: 7, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'schneider-evlink', name: 'EVlink Pro AC', vendor: 'Schneider Electric', connectors: 1, firmware: '2.2.2', meterType: 'Internal', prefix: 'SN', suffix: '--D', idLength: 7, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'orbis-viaris', name: 'VIARIS COMBIPLUS', vendor: 'Orbis', connectors: 1, firmware: '7.3.74', meterType: 'Internal', prefix: 'EVVC', suffix: '--D', idLength: 9, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'evbox-g4e-m5320e', name: 'G4E-M5320E', vendor: 'EV-Box', connectors: 1, firmware: 'P0425B0425v0.240410_W2.2.0', meterType: 'MID', prefix: 'EVB-', suffix: '--D', idLength: 8, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'evbox-g4e-wbw', name: 'G4E-WBW', vendor: 'EV-Box', connectors: 1, firmware: 'P0422B0422v0.211223_U6.0.0-050', meterType: 'MID', prefix: 'EVB-', suffix: '--D', idLength: 8, includeNumbers: 'y', includeLetters: 'n' },
      { id: 'evbox-g4x', name: 'G4X-WBO-M7500E', vendor: 'EV-Box', connectors: 2, firmware: 'P0425B0425v0.240410_W7.1.0-020', meterType: 'MID', prefix: 'EVB-', suffix: '--D', idLength: 8, includeNumbers: 'y', includeLetters: 'n' },
    ];

    let models = JSON.parse(localStorage.getItem('chargerModels')) || [...defaultModels];
    let carProfiles = [];
    let plugCarTarget = null; // { cpId, connectorId }
    let plugchoiceSites = []; // cached sites from Plugchoice
    let chargerSiteMap = {}; // identity -> { siteName, siteUuid }
    let hasPlugchoiceToken = false;

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      loadChargers();
      loadCarProfiles();
      renderModels();
      populateModelSelects();
      checkPlugchoiceToken();
      refreshInterval = setInterval(loadChargers, 5000);
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) document.getElementById('actionsDropdown').classList.remove('show');
        if (!e.target.closest('.checkbox-cell')) document.getElementById('selectPctPopover').classList.remove('show');
      });
      updateModelIdPreview();
      ['modelPrefix', 'modelSuffix', 'modelIdLength', 'modelIncludeNumbers', 'modelIncludeLetters'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateModelIdPreview);
        document.getElementById(id).addEventListener('change', updateModelIdPreview);
      });
    });

    // API
    async function api(endpoint, options = {}) {
      const response = await fetch(`${API_BASE}${endpoint}`, { ...options, headers: { 'Content-Type': 'application/json', ...options.headers } });
      return response.json();
    }

    function copyToClipboard(text, event) {
      if (event) event.stopPropagation();
      navigator.clipboard.writeText(text).then(() => showToast(`Copied: ${text}`, 'success'));
    }

    // Generate random ID based on rules
    function generateRandomId(model) {
      let chars = '';
      if (model.includeNumbers === 'y') chars += '0123456789';
      if (model.includeLetters === 'y') chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      if (!chars) chars = '0123456789';
      let result = '';
      for (let i = 0; i < model.idLength; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
      return `${model.prefix || ''}${result}${model.suffix || ''}`;
    }

    // Generate ICCID, IMSI, meterSerialNumber
    function generateIccid() { return '89' + Array.from({length: 17}, () => Math.floor(Math.random() * 10)).join(''); }
    function generateImsi() { return '204' + Array.from({length: 12}, () => Math.floor(Math.random() * 10)).join(''); }
    function generateMeterSerial() { const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; return letters[Math.floor(Math.random() * 26)] + '6' + letters[Math.floor(Math.random() * 26)] + Array.from({length: 6}, () => Math.floor(Math.random() * 10)).join(''); }

    // Load chargers
    async function loadChargers() {
      try {
        const status = await api('/status');
        document.getElementById('wsUrlInput').value = status.wsUrl;
        document.getElementById('navStatusText').textContent = `${status.connectedChargers}/${status.totalChargers} online`;
        document.getElementById('navStatusDot').className = status.connectedChargers > 0 ? 'nav-status-dot' : 'nav-status-dot offline';
        chargers = await api('/chargers');
        populateFilterOptions();
        renderTable();
        updateStats();
      } catch (err) { console.error('Failed to load chargers:', err); }
    }

    function getFilteredChargers() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const vendor = document.getElementById('filterVendor').value;
      const model = document.getElementById('filterModel').value;
      const install = document.getElementById('filterInstall').value;
      const connCount = document.getElementById('filterConnectors').value;
      const connection = document.getElementById('filterConnection').value;
      const connStatus = document.getElementById('filterConnectorStatus').value;
      const locFilter = document.getElementById('filterLocation').value;
      return chargers.filter(c => {
        if (search && !c.cpId.toLowerCase().includes(search)) return false;
        if (vendor && c.config.vendor !== vendor) return false;
        if (model && c.config.model !== model) return false;
        if (install && String(c.config.phases || 3) !== install) return false;
        if (connCount && String(c.connectors.length) !== connCount) return false;
        if (connection === 'connected' && !c.connected) return false;
        if (connection === 'disconnected' && c.connected) return false;
        if (connStatus && !c.connectors.some(cn => cn.status === connStatus)) return false;
        if (locFilter === 'attached' && !chargerSiteMap[c.cpId]) return false;
        if (locFilter === 'unattached' && chargerSiteMap[c.cpId]) return false;
        return true;
      });
    }

    function populateFilterOptions() {
      const vendors = [...new Set(chargers.map(c => c.config.vendor))].sort();
      const models = [...new Set(chargers.map(c => c.config.model))].sort();
      const vendorEl = document.getElementById('filterVendor');
      const modelEl = document.getElementById('filterModel');
      const curVendor = vendorEl.value;
      const curModel = modelEl.value;
      vendorEl.innerHTML = '<option value="">All Vendors</option>' + vendors.map(v => `<option value="${v}"${v === curVendor ? ' selected' : ''}>${v}</option>`).join('');
      modelEl.innerHTML = '<option value="">All Models</option>' + models.map(m => `<option value="${m}"${m === curModel ? ' selected' : ''}>${m}</option>`).join('');
    }

    function renderTable() {
      const tbody = document.getElementById('chargersTableBody');
      const empty = document.getElementById('tableEmpty');
      const filtered = getFilteredChargers();
      document.getElementById('filterCount').textContent = `${filtered.length} / ${chargers.length} chargers`;
      if (filtered.length === 0) { tbody.innerHTML = ''; empty.style.display = 'block'; document.querySelector('table thead').style.display = 'none'; return; }
      document.querySelector('table thead').style.display = ''; empty.style.display = 'none';
      tbody.innerHTML = filtered.map(charger => {
        const getConnectorStatus = (idx) => {
          const conn = charger.connectors.find(c => c.connectorId === idx);
          if (!conn) return '<span class="text-muted">-</span>';
          const evTag = conn.carSimulator ? `<span class="ev-tag">EV ${conn.carSimulator.socPercent}%</span>` : '';
          if (!charger.connected) return `<span class="status-badge offline"><span class="status-badge-dot"></span>${conn.status}</span>${evTag}`;
          return `<span class="status-badge ${conn.status}"><span class="status-badge-dot"></span>${conn.status}</span>${evTag}`;
        };
        const siteInfo = chargerSiteMap[charger.cpId];
        const locCell = siteInfo ? `<span style="font-size:13px;">${siteInfo.siteName}</span>` : '<span class="text-muted">-</span>';
        return `<tr><td class="checkbox-cell" onclick="event.stopPropagation();"><input type="checkbox" ${selectedChargers.has(charger.cpId) ? 'checked' : ''} onchange="toggleSelection('${charger.cpId}')"></td><td class="charger-id-cell copyable" onclick="copyToClipboard('${charger.cpId}', event)" title="Click to copy">${charger.cpId}</td><td onclick="openChargerPanel('${charger.cpId}')">${locCell}</td><td onclick="openChargerPanel('${charger.cpId}')">${getConnectorStatus(0)}</td><td onclick="openChargerPanel('${charger.cpId}')">${getConnectorStatus(1)}</td><td onclick="openChargerPanel('${charger.cpId}')">${getConnectorStatus(2)}</td><td onclick="openChargerPanel('${charger.cpId}')">${charger.config.vendor}</td><td onclick="openChargerPanel('${charger.cpId}')">${charger.config.model}</td><td onclick="openChargerPanel('${charger.cpId}')">${(charger.config.phases || 3) === 1 ? '1ph' : '3ph'}</td></tr>`;
      }).join('');
    }

    function updateStats() {
      const total = chargers.length;
      const connected = chargers.filter(c => c.connected).length;
      const charging = chargers.reduce((sum, c) => sum + c.connectors.filter(conn => conn.status === 'Charging').length, 0);
      const totalPower = chargers.reduce((sum, c) => sum + c.connectors.reduce((s, conn) => s + (conn.powerImport || 0), 0), 0);
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statConnected').textContent = connected;
      document.getElementById('statCharging').textContent = charging;
      document.getElementById('statPower').textContent = (totalPower / 1000).toFixed(1) + ' kW';
      document.getElementById('chargerCountBadge').textContent = total;
    }

    // Selection
    function toggleSelection(cpId) { if (selectedChargers.has(cpId)) selectedChargers.delete(cpId); else selectedChargers.add(cpId); updateSelectionUI(); }
    function toggleSelectAll() {
      const checked = document.getElementById('selectAllCheckbox').checked;
      const filtered = getFilteredChargers();
      if (checked) filtered.forEach(c => selectedChargers.add(c.cpId)); else filtered.forEach(c => selectedChargers.delete(c.cpId));
      updateSelectionUI(); renderTable();
    }
    function clearSelection() { selectedChargers.clear(); document.getElementById('selectAllCheckbox').checked = false; updateSelectionUI(); renderTable(); }
    function updateSelectionUI() { const count = selectedChargers.size; document.getElementById('selectedCount').textContent = count; document.getElementById('selectionInfo').classList.toggle('show', count > 0); }
    function filterChargers() { populateFilterOptions(); renderTable(); }
    function resetFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterVendor').value = '';
      document.getElementById('filterModel').value = '';
      document.getElementById('filterInstall').value = '';
      document.getElementById('filterConnectors').value = '';
      document.getElementById('filterConnection').value = '';
      document.getElementById('filterConnectorStatus').value = '';
      document.getElementById('filterLocation').value = '';
      filterChargers();
    }
    function toggleSelectPctPopover() {
      const pop = document.getElementById('selectPctPopover');
      pop.classList.toggle('show');
      if (pop.classList.contains('show')) document.getElementById('selectPctInput').focus();
    }
    function selectRandomPercent() {
      const pct = Math.min(100, Math.max(0, parseInt(document.getElementById('selectPctInput').value) || 0));
      const filtered = getFilteredChargers();
      const count = Math.round(filtered.length * pct / 100);
      // Shuffle and pick
      const shuffled = [...filtered].sort(() => Math.random() - 0.5);
      const picked = shuffled.slice(0, count);
      // Clear current selection of filtered chargers, then apply new
      filtered.forEach(c => selectedChargers.delete(c.cpId));
      picked.forEach(c => selectedChargers.add(c.cpId));
      document.getElementById('selectPctPopover').classList.remove('show');
      document.getElementById('selectAllCheckbox').checked = false;
      updateSelectionUI(); renderTable();
      showToast(`Selected ${picked.length} of ${filtered.length} chargers (${pct}%)`, 'success');
    }

    // Pages
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(`page-${page}`).classList.add('active');
      const navPage = page === 'location-detail' ? 'locations' : page;
      const navItem = document.querySelector(`.nav-item[onclick="showPage('${navPage}')"]`);
      if (navItem) navItem.classList.add('active');
      if (page === 'locations') loadLocations();
    }

    // Actions
    function toggleActionsDropdown() { event.stopPropagation(); document.getElementById('actionsDropdown').classList.toggle('show'); }
    function bulkAction(action) {
      document.getElementById('actionsDropdown').classList.remove('show');
      if (selectedChargers.size === 0) { showToast('Please select at least one charger', 'error'); return; }
      switch (action) {
        case 'hardReset': if (confirm(`Hard reset ${selectedChargers.size} charger(s)?`)) { showToast(`Hard reset sent to ${selectedChargers.size} charger(s)`, 'success'); } break;
        case 'startTransaction': bulkStartTransaction(); break;
        case 'stopTransaction': bulkStopTransaction(); break;
        case 'setMaxCurrent': document.getElementById('maxCurrentCount').textContent = selectedChargers.size; document.getElementById('maxCurrentModal').classList.add('show'); break;
        case 'changeConfiguration': document.getElementById('configCount').textContent = selectedChargers.size; document.getElementById('configModal').classList.add('show'); break;
        case 'connect': bulkConnect(); break;
        case 'disconnect': bulkDisconnect(); break;
        case 'attachLocation': showAttachLocationModal(); break;
        case 'exportCsv': exportSelectedCsv(); break;
        case 'exportIds': exportSelectedIds(); break;
        case 'delete': bulkDelete(); break;
      }
    }

    async function bulkConnect() {
      showToast(`Connecting ${selectedChargers.size} charger(s)...`, 'success');
      for (const cpId of selectedChargers) {
        await api(`/chargers/${cpId}/connect`, { method: 'POST' });
      }
      loadChargers();
    }

    async function bulkDisconnect() {
      showToast(`Disconnecting ${selectedChargers.size} charger(s)...`, 'success');
      for (const cpId of selectedChargers) {
        await api(`/chargers/${cpId}/disconnect`, { method: 'POST' });
      }
      loadChargers();
    }

    async function bulkDelete() {
      if (!confirm(`Delete ${selectedChargers.size} charger(s)? This cannot be undone.`)) return;
      for (const cpId of selectedChargers) {
        await api(`/chargers/${cpId}`, { method: 'DELETE' });
      }
      selectedChargers.clear();
      updateSelectionUI();
      showToast(`Deleted chargers`, 'success');
      loadChargers();
    }

    function downloadCsv(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportSelectedCsv() {
      const selected = chargers.filter(c => selectedChargers.has(c.cpId));
      const headers = ['Chargepoint ID', 'Location', 'Conn. 0', 'Conn. 1', 'Conn. 2', 'Vendor', 'Model', 'Install'];
      const rows = selected.map(c => {
        const connStatus = (idx) => { const conn = c.connectors.find(cn => cn.connectorId === idx); return conn ? conn.status : ''; };
        const install = (c.config.phases || 3) === 1 ? '1ph' : '3ph';
        const loc = chargerSiteMap[c.cpId]?.siteName || '';
        return [c.cpId, loc, connStatus(0), connStatus(1), connStatus(2), c.config.vendor, c.config.model, install].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
      });
      downloadCsv([headers.join(','), ...rows].join('\n'), 'chargers.csv');
      showToast(`Exported ${selected.length} charger(s) to CSV`, 'success');
    }

    function exportSelectedIds() {
      const selected = chargers.filter(c => selectedChargers.has(c.cpId));
      const rows = selected.map(c => `"${c.cpId.replace(/"/g, '""')}"`);
      downloadCsv(['identity', ...rows].join('\n'), 'charger-ids.csv');
      showToast(`Exported ${selected.length} charger ID(s)`, 'success');
    }

    // Get a random unused idTag from the charger's location cards
    let _siteCardsCache = {}; // siteUuid -> cards[]
    async function getIdTagForCharger(cpId) {
      const siteInfo = chargerSiteMap[cpId];
      if (!siteInfo) return 'VIRTUAL001'; // fallback if charger has no location

      // Fetch & cache cards for this site
      if (!_siteCardsCache[siteInfo.siteUuid]) {
        try {
          _siteCardsCache[siteInfo.siteUuid] = await api(`/plugchoice/sites/${siteInfo.siteUuid}/cards`);
        } catch(e) { return 'VIRTUAL001'; }
      }
      const siteCards = _siteCardsCache[siteInfo.siteUuid];
      if (!siteCards || siteCards.length === 0) return 'VIRTUAL001';

      // Collect idTags currently in active transactions at this location
      const activeIdTags = new Set();
      for (const ch of chargers) {
        if (chargerSiteMap[ch.cpId]?.siteUuid === siteInfo.siteUuid) {
          for (const conn of (ch.connectors || [])) {
            if (conn.transactionId && conn.idTag) activeIdTags.add(conn.idTag);
          }
        }
      }

      // Filter to unused cards
      const available = siteCards.filter(c => !activeIdTags.has(c.id_token));
      const pool = available.length > 0 ? available : siteCards; // fallback to all if all used
      return pool[Math.floor(Math.random() * pool.length)].id_token;
    }

    async function bulkStartTransaction() {
      showToast(`Starting transactions on ${selectedChargers.size} charger(s)...`, 'success');
      _siteCardsCache = {}; // clear cache for fresh data
      for (const cpId of selectedChargers) {
        const ch = chargers.find(c => c.cpId === cpId);
        if (!ch || !ch.connected) continue;
        for (const conn of ch.connectors) {
          const idTag = await getIdTagForCharger(cpId);
          await api(`/chargers/${cpId}/connectors/${conn.connectorId}/start-transaction`, { method: 'POST', body: JSON.stringify({ idTag }) });
        }
      }
      loadChargers();
    }

    async function bulkStopTransaction() {
      showToast(`Stopping transactions on ${selectedChargers.size} charger(s)...`, 'success');
      for (const cpId of selectedChargers) {
        const ch = chargers.find(c => c.cpId === cpId);
        if (!ch || !ch.connected) continue;
        for (const conn of ch.connectors) {
          if (conn.transactionId) {
            await api(`/chargers/${cpId}/connectors/${conn.connectorId}/stop-transaction`, { method: 'POST' });
          }
        }
      }
      loadChargers();
    }

    async function disconnectAll() {
      const connectedCount = chargers.filter(c => c.connected).length;
      if (connectedCount === 0) { showToast('No chargers connected', 'error'); return; }
      showToast(`Disconnecting all ${connectedCount} charger(s)...`, 'success');
      for (const charger of chargers.filter(c => c.connected)) {
        await api(`/chargers/${charger.cpId}/disconnect`, { method: 'POST' });
      }
      loadChargers();
    }
    function closeMaxCurrentModal() { document.getElementById('maxCurrentModal').classList.remove('show'); }
    async function applyMaxCurrent() { const current = document.getElementById('bulkCurrentSlider').value; await api('/bulk/current', { method: 'POST', body: JSON.stringify({ cpIds: Array.from(selectedChargers), connectorId: 'all', currentAmps: parseInt(current, 10) }) }); closeMaxCurrentModal(); showToast(`Max current set to ${current}A`, 'success'); loadChargers(); }
    function closeConfigModal() { document.getElementById('configModal').classList.remove('show'); }
    async function applyConfig() { const key = document.getElementById('configKey').value; const value = document.getElementById('configValue').value; if (!value) { showToast('Please enter a value', 'error'); return; } await api('/bulk/config', { method: 'POST', body: JSON.stringify({ cpIds: Array.from(selectedChargers), key, value }) }); closeConfigModal(); showToast(`Configuration sent`, 'success'); }

    // Charger Panel
    function openChargerPanel(cpId) {
      currentCharger = chargers.find(c => c.cpId === cpId); if (!currentCharger) return;
      document.getElementById('panelChargerTitle').textContent = cpId;
      document.getElementById('panelChargerSubtitle').textContent = `${currentCharger.config.vendor} ${currentCharger.config.model}`;
      document.getElementById('panelStatus').textContent = currentCharger.connected ? 'Online' : 'Offline';
      document.getElementById('panelSerial').textContent = currentCharger.config.serialNumber || cpId;
      document.getElementById('panelFirmware').textContent = currentCharger.config.firmwareVersion || '1.0.0';
      document.getElementById('panelMaxCurrent').textContent = (currentCharger.config.phases || 3) === 1 ? '1-phase (L1+N)' : '3-phase (L1+L2+L3+N)';
      const hasAnyCar = currentCharger.connectors.some(c => c.carSimulator);
      document.getElementById('panelConnectors').innerHTML = currentCharger.connectors.map(conn => {
        const sim = conn.carSimulator;
        let carSection = '';
        if (sim) {
          const socClass = getSocBarClass(sim.socPercent);
          const displayCurrent = sim.actualCurrentA !== undefined ? sim.actualCurrentA.toFixed(1) : '0.0';
          const displayEnergy = ((sim.energyDeliveredWh || 0) / 1000).toFixed(2);
          carSection = `
            <div class="car-info-card">
              <div class="car-info-card-header">
                <span class="car-info-card-name">${sim.profileName}</span>
                <button class="unplug-btn" onclick="event.stopPropagation(); unplugCar('${currentCharger.cpId}', ${conn.connectorId})">Unplug</button>
              </div>
              <div class="soc-label-row">
                <span class="soc-label">State of Charge</span>
                <span class="soc-percent">${sim.socPercent}%</span>
              </div>
              <div class="soc-bar-container"><div class="soc-bar ${socClass}" style="width: ${sim.socPercent}%"></div></div>
              <div class="car-info-card-grid" style="margin-top: 10px;">
                <div class="car-info-stat"><div class="car-info-stat-label">Actual Draw</div><div class="car-info-stat-value">${displayCurrent} A</div></div>
                <div class="car-info-stat"><div class="car-info-stat-label">EV Energy</div><div class="car-info-stat-value">${displayEnergy} kWh</div></div>
                <div class="car-info-stat"><div class="car-info-stat-label">Battery</div><div class="car-info-stat-value">${sim.batteryCapacityKwh} kWh</div></div>
                <div class="car-info-stat"><div class="car-info-stat-label">Charging</div><div class="car-info-stat-value">${sim.effectivePhases || sim.phases}ph</div></div>
              </div>
            </div>`;
        } else {
          carSection = `<button class="plug-car-btn" onclick="event.stopPropagation(); showPlugCarModal('${currentCharger.cpId}', ${conn.connectorId})">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            Plug In EV
          </button>`;
        }
        return `<div class="connector-card"><div class="connector-card-header"><span class="connector-card-title">Connector ${conn.connectorId}</span><span class="status-badge ${conn.status}"><span class="status-badge-dot"></span>${conn.status}</span></div><div class="connector-card-grid"><div class="connector-stat"><div class="connector-stat-label">${sim ? 'Offered Current' : 'Current'}</div><div class="connector-stat-value">${conn.currentImport || 0} A</div></div><div class="connector-stat"><div class="connector-stat-label">Power</div><div class="connector-stat-value">${((conn.powerImport || 0) / 1000).toFixed(1)} kW</div></div><div class="connector-stat"><div class="connector-stat-label">Energy</div><div class="connector-stat-value">${((conn.energyImported || 0) / 1000).toFixed(2)} kWh</div></div><div class="connector-stat"><div class="connector-stat-label">Transaction</div><div class="connector-stat-value">${conn.transactionId || '-'}</div></div></div>${carSection}</div>`;
      }).join('');
      // Relabel current slider when a car is plugged in
      document.getElementById('panelCurrentLabel').textContent = hasAnyCar ? 'EVSE Offered Current' : 'Charging Current';
      document.getElementById('panelOverlay').classList.add('show');
      document.getElementById('chargerPanel').classList.add('show');
    }
    function closeChargerPanel() { document.getElementById('panelOverlay').classList.remove('show'); document.getElementById('chargerPanel').classList.remove('show'); currentCharger = null; }
    function updatePanelCurrent() { document.getElementById('panelCurrentValue').textContent = document.getElementById('panelCurrentSlider').value + ' A'; }
    async function applyPanelCurrent() { if (!currentCharger) return; const current = document.getElementById('panelCurrentSlider').value; for (const conn of currentCharger.connectors) { await api(`/chargers/${currentCharger.cpId}/connectors/${conn.connectorId}/current`, { method: 'POST', body: JSON.stringify({ currentAmps: parseInt(current, 10) }) }); } showToast(`Current set to ${current}A`, 'success'); loadChargers(); }
    async function chargerAction(action) {
      if (!currentCharger) return;
      switch (action) {
        case 'connect':
          await api(`/chargers/${currentCharger.cpId}/connect`, { method: 'POST' });
          showToast('Connecting...', 'success');
          break;
        case 'startTransaction':
          _siteCardsCache = {};
          for (const conn of currentCharger.connectors) {
            const idTag = await getIdTagForCharger(currentCharger.cpId);
            await api(`/chargers/${currentCharger.cpId}/connectors/${conn.connectorId}/start-transaction`, { method: 'POST', body: JSON.stringify({ idTag }) });
          }
          showToast('Transaction starting...', 'success');
          break;
        case 'stopTransaction':
          for (const conn of currentCharger.connectors) {
            if (conn.transactionId) {
              await api(`/chargers/${currentCharger.cpId}/connectors/${conn.connectorId}/stop-transaction`, { method: 'POST' });
            }
          }
          showToast('Transaction stopped', 'success');
          break;
        default:
          showToast(`${action} sent`, 'success');
      }
      loadChargers();
    }
    async function deleteCurrentCharger() { if (!currentCharger || !confirm(`Delete charger ${currentCharger.cpId}?`)) return; await api(`/chargers/${currentCharger.cpId}`, { method: 'DELETE' }); closeChargerPanel(); showToast('Charger deleted', 'success'); loadChargers(); }

    // Add Charger Modal
    function showAddChargerModal() { populateModelSelects(); document.getElementById('addChargerModal').classList.add('show'); }
    function closeAddChargerModal() { document.getElementById('addChargerModal').classList.remove('show'); }
    function onModelSelectChange() {
      const modelId = document.getElementById('addChargerModel').value;
      const customFields = document.getElementById('customChargerFields');
      if (modelId) {
        const model = models.find(m => m.id === modelId);
        if (model) {
          document.getElementById('addCpId').value = generateRandomId(model);
          document.getElementById('addVendor').value = model.vendor;
          document.getElementById('addModel').value = model.name;
          document.getElementById('addConnectors').value = model.connectors;
          document.getElementById('addFirmware').value = model.firmware;
          document.getElementById('addMeterType').value = model.meterType;
        }
      }
    }
    async function addCharger() {
      const modelId = document.getElementById('addChargerModel').value;
      let cpId = document.getElementById('addCpId').value;
      if (modelId && !cpId) {
        const model = models.find(m => m.id === modelId);
        cpId = generateRandomId(model);
      }
      if (!cpId) { showToast('Charge Point ID is required', 'error'); return; }
      const result = await api('/chargers', { method: 'POST', body: JSON.stringify({
        cpId,
        vendor: document.getElementById('addVendor').value,
        model: document.getElementById('addModel').value,
        serialNumber: document.getElementById('addSerial').value || cpId,
        connectors: parseInt(document.getElementById('addConnectors').value, 10),
        phases: parseInt(document.getElementById('addPhases').value, 10),
        firmwareVersion: document.getElementById('addFirmware').value,
        meterType: document.getElementById('addMeterType').value,
        iccid: generateIccid(),
        imsi: generateImsi(),
        meterSerialNumber: generateMeterSerial()
      }) });
      if (result.success) { closeAddChargerModal(); document.getElementById('addCpId').value = ''; showToast(`Charger ${cpId} added`, 'success'); loadChargers(); } else { showToast(result.error || 'Failed to add charger', 'error'); }
    }

    // Generate Modal
    function showGenerateModal() { populateModelSelects(); document.getElementById('generateModal').classList.add('show'); }
    function closeGenerateModal() { document.getElementById('generateModal').classList.remove('show'); }
    function onGenModelSelectChange() {
      const modelId = document.getElementById('genModelSelect').value;
      const preview = document.getElementById('genPreview');
      const previewIds = document.getElementById('genPreviewIds');
      if (modelId) {
        const model = models.find(m => m.id === modelId);
        if (model) {
          preview.style.display = 'block';
          previewIds.innerHTML = [1,2,3].map(() => generateRandomId(model)).join('<br>');
        }
      } else { preview.style.display = 'none'; }
    }
    async function generateChargers() {
      const modelId = document.getElementById('genModelSelect').value;
      const count = parseInt(document.getElementById('genCount').value, 10);
      if (!modelId) { showToast('Please select a model', 'error'); return; }
      if (!count) { showToast('Please enter a count', 'error'); return; }
      const model = models.find(m => m.id === modelId);
      let successCount = 0;
      for (let i = 0; i < count; i++) {
        const cpId = generateRandomId(model);
        const result = await api('/chargers', { method: 'POST', body: JSON.stringify({
          cpId, vendor: model.vendor, model: model.name, serialNumber: cpId,
          connectors: model.connectors, phases: parseInt(document.getElementById('genPhases').value, 10) || 3,
          firmwareVersion: model.firmware, meterType: model.meterType,
          iccid: generateIccid(), imsi: generateImsi(), meterSerialNumber: generateMeterSerial()
        }) });
        if (result.success) successCount++;
      }
      closeGenerateModal();
      showToast(`Generated ${successCount} chargers`, 'success');
      loadChargers();
    }

    // Models
    let modelSortColumn = 'vendor';
    let modelSortDirection = 'asc';

    function renderModels() {
      document.getElementById('modelCountBadge').textContent = models.length;
      populateVendorFilter();
      filterModels();
    }

    function populateVendorFilter() {
      const vendors = [...new Set(models.map(m => m.vendor))].sort();
      const select = document.getElementById('modelVendorFilter');
      const currentValue = select.value;
      select.innerHTML = '<option value="">All Vendors</option>' + vendors.map(v => `<option value="${v}">${v}</option>`).join('');
      select.value = currentValue;
    }

    function filterModels() {
      const search = document.getElementById('modelSearchInput').value.toLowerCase();
      const vendorFilter = document.getElementById('modelVendorFilter').value;
      const meterFilter = document.getElementById('modelMeterFilter').value;

      let filtered = models.filter(m => {
        const matchesSearch = m.name.toLowerCase().includes(search) || m.vendor.toLowerCase().includes(search) || m.firmware.toLowerCase().includes(search);
        const matchesVendor = !vendorFilter || m.vendor === vendorFilter;
        const matchesMeter = !meterFilter || m.meterType === meterFilter;
        return matchesSearch && matchesVendor && matchesMeter;
      });

      // Sort
      filtered.sort((a, b) => {
        let aVal = a[modelSortColumn];
        let bVal = b[modelSortColumn];
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
        if (aVal < bVal) return modelSortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return modelSortDirection === 'asc' ? 1 : -1;
        return 0;
      });

      document.getElementById('modelFilterCount').textContent = filtered.length;
      updateSortIcons();
      renderModelsTable(filtered);
    }

    function sortModels(column) {
      if (modelSortColumn === column) {
        modelSortDirection = modelSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        modelSortColumn = column;
        modelSortDirection = 'asc';
      }
      filterModels();
    }

    function updateSortIcons() {
      document.querySelectorAll('#modelsTable .sort-icon').forEach(icon => {
        icon.classList.remove('asc', 'desc');
        if (icon.dataset.col === modelSortColumn) {
          icon.classList.add(modelSortDirection);
        }
      });
    }

    function renderModelsTable(filteredModels) {
      const tbody = document.getElementById('modelsTableBody');
      if (filteredModels.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">No models found</td></tr>';
        return;
      }
      tbody.innerHTML = filteredModels.map(m => {
        const pattern = `${m.prefix || ''}<span style="color: var(--text-muted);">×${m.idLength}</span>${m.suffix || ''}`;
        const chars = (m.includeNumbers === 'y' ? '0-9' : '') + (m.includeLetters === 'y' ? 'A-Z' : '');
        return `<tr>
          <td><strong>${m.name}</strong></td>
          <td>${m.vendor}</td>
          <td style="text-align: center;">${m.connectors}</td>
          <td><span class="text-muted" title="${m.firmware}">${m.firmware.length > 20 ? m.firmware.substring(0, 20) + '...' : m.firmware}</span></td>
          <td><span class="tag">${m.meterType}</span></td>
          <td><span class="id-pattern">${pattern}</span> <span class="text-muted" style="font-size: 11px;">${chars}</span></td>
          <td style="text-align: center;">${m.idLength}</td>
          <td>
            <button class="action-btn primary" onclick="event.stopPropagation(); quickGenerate('${m.id}')" title="Generate charger">+ Gen</button>
            <button class="action-btn" onclick="event.stopPropagation(); editModel('${m.id}')" title="Edit model">Edit</button>
          </td>
        </tr>`;
      }).join('');
    }

    function quickGenerate(modelId) {
      const model = models.find(m => m.id === modelId);
      if (!model) return;
      const cpId = generateRandomId(model);
      api('/chargers', { method: 'POST', body: JSON.stringify({
        cpId, vendor: model.vendor, model: model.name, serialNumber: cpId,
        connectors: model.connectors, firmwareVersion: model.firmware, meterType: model.meterType,
        iccid: generateIccid(), imsi: generateImsi(), meterSerialNumber: generateMeterSerial()
      }) }).then(result => {
        if (result.success) { showToast(`Generated ${cpId}`, 'success'); loadChargers(); }
        else { showToast(result.error || 'Failed', 'error'); }
      });
    }

    function populateModelSelects() {
      const opts = models.map(m => `<option value="${m.id}">${m.vendor} - ${m.name}</option>`).join('');
      document.getElementById('addChargerModel').innerHTML = '<option value="">-- Custom (no template) --</option>' + opts;
      document.getElementById('genModelSelect').innerHTML = '<option value="">-- Select a model --</option>' + opts;
    }

    function showAddModelModal() { editingModelId = null; document.getElementById('modelModalTitle').textContent = 'Add Model'; document.getElementById('deleteModelBtn').style.display = 'none'; clearModelForm(); document.getElementById('modelModal').classList.add('show'); updateModelIdPreview(); }
    function editModel(id) {
      const model = models.find(m => m.id === id); if (!model) return;
      editingModelId = id;
      document.getElementById('modelModalTitle').textContent = 'Edit Model';
      document.getElementById('deleteModelBtn').style.display = 'block';
      document.getElementById('modelName').value = model.name;
      document.getElementById('modelVendor').value = model.vendor;
      document.getElementById('modelConnectors').value = model.connectors;
      document.getElementById('modelFirmware').value = model.firmware;
      document.getElementById('modelMeterType').value = model.meterType;
      document.getElementById('modelPrefix').value = model.prefix || '';
      document.getElementById('modelSuffix').value = model.suffix || '';
      document.getElementById('modelIdLength').value = model.idLength;
      document.getElementById('modelIncludeNumbers').value = model.includeNumbers;
      document.getElementById('modelIncludeLetters').value = model.includeLetters;
      document.getElementById('modelModal').classList.add('show');
      updateModelIdPreview();
    }
    function closeModelModal() { document.getElementById('modelModal').classList.remove('show'); editingModelId = null; }
    function clearModelForm() { ['modelName','modelVendor','modelFirmware','modelPrefix','modelSuffix'].forEach(id => document.getElementById(id).value = ''); document.getElementById('modelConnectors').value = 1; document.getElementById('modelIdLength').value = 8; document.getElementById('modelMeterType').value = 'Internal'; document.getElementById('modelIncludeNumbers').value = 'y'; document.getElementById('modelIncludeLetters').value = 'n'; }
    function updateModelIdPreview() {
      const model = { prefix: document.getElementById('modelPrefix').value, suffix: document.getElementById('modelSuffix').value, idLength: parseInt(document.getElementById('modelIdLength').value) || 8, includeNumbers: document.getElementById('modelIncludeNumbers').value, includeLetters: document.getElementById('modelIncludeLetters').value };
      document.getElementById('modelIdPreview').textContent = generateRandomId(model);
    }
    function saveModel() {
      const name = document.getElementById('modelName').value; const vendor = document.getElementById('modelVendor').value;
      if (!name || !vendor) { showToast('Name and vendor are required', 'error'); return; }
      const modelData = { name, vendor, connectors: parseInt(document.getElementById('modelConnectors').value) || 1, firmware: document.getElementById('modelFirmware').value || '1.0.0', meterType: document.getElementById('modelMeterType').value, prefix: document.getElementById('modelPrefix').value, suffix: document.getElementById('modelSuffix').value, idLength: parseInt(document.getElementById('modelIdLength').value) || 8, includeNumbers: document.getElementById('modelIncludeNumbers').value, includeLetters: document.getElementById('modelIncludeLetters').value };
      if (editingModelId) { const idx = models.findIndex(m => m.id === editingModelId); if (idx !== -1) { models[idx] = { ...models[idx], ...modelData }; } }
      else { modelData.id = 'custom-' + Date.now(); models.push(modelData); }
      localStorage.setItem('chargerModels', JSON.stringify(models));
      closeModelModal(); renderModels(); populateModelSelects(); showToast('Model saved', 'success');
    }
    function deleteModel() { if (!editingModelId || !confirm('Delete this model?')) return; models = models.filter(m => m.id !== editingModelId); localStorage.setItem('chargerModels', JSON.stringify(models)); closeModelModal(); renderModels(); populateModelSelects(); showToast('Model deleted', 'success'); }

    // Settings
    async function saveWsUrl() { await api('/settings/ws-url', { method: 'POST', body: JSON.stringify({ wsUrl: document.getElementById('wsUrlInput').value }) }); showToast('WebSocket URL saved', 'success'); }
    async function connectAll() { showToast('Connecting all chargers...', 'success'); await api('/chargers/connect-all', { method: 'POST' }); loadChargers(); }

    // Car Simulator
    async function loadCarProfiles() {
      try {
        const data = await api('/car-profiles');
        if (!Array.isArray(data)) { console.error('Car profiles response is not an array:', data); return; }
        carProfiles = data;
        const select = document.getElementById('plugCarProfile');
        select.innerHTML = carProfiles.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        updatePlugCarPreview();
      } catch (err) { console.error('Failed to load car profiles:', err); }
    }

    async function showPlugCarModal(cpId, connectorId) {
      plugCarTarget = { cpId, connectorId };
      document.getElementById('plugCarSoc').value = 20;
      document.getElementById('plugCarSocValue').textContent = '20%';
      // Always reload profiles when opening modal to ensure dropdown is populated
      if (carProfiles.length === 0) await loadCarProfiles();
      updatePlugCarPreview();
      document.getElementById('plugCarModal').classList.add('show');
    }
    function closePlugCarModal() { document.getElementById('plugCarModal').classList.remove('show'); plugCarTarget = null; }

    function updatePlugCarPreview() {
      document.getElementById('plugCarSocValue').textContent = document.getElementById('plugCarSoc').value + '%';
      const profileId = document.getElementById('plugCarProfile').value;
      const soc = parseInt(document.getElementById('plugCarSoc').value) / 100;
      const profile = carProfiles.find(p => p.id === profileId);
      if (profile) {
        // Compute effective phases: min of charger installation and car phases
        const charger = plugCarTarget ? chargers.find(c => c.cpId === plugCarTarget.cpId) : null;
        const chargerPhases = charger?.config?.phases || 3;
        const effectivePhases = Math.min(profile.phases, chargerPhases);
        const effectivePowerKw = (effectivePhases * 230 * profile.maxAcCurrentA) / 1000;
        const remainingKwh = profile.batteryCapacityKwh * (1 - soc);
        const hoursEstimate = remainingKwh / effectivePowerKw;
        const hours = Math.floor(hoursEstimate);
        const minutes = Math.round((hoursEstimate - hours) * 60);
        const phaseNote = effectivePhases < profile.phases
          ? ` (car is ${profile.phases}ph, charger is ${chargerPhases}ph)`
          : '';
        document.getElementById('plugCarEstimate').innerHTML =
          `<strong>${profile.name}</strong>: ${remainingKwh.toFixed(1)} kWh to charge (${profile.batteryCapacityKwh} kWh battery)<br>` +
          `Charging at ${effectivePhases}x${profile.maxAcCurrentA}A = ${effectivePowerKw.toFixed(1)} kW${phaseNote}<br>` +
          `Estimated time: ~${hours}h ${minutes}m<br>` +
          `<span style="font-size:11px; color:var(--text-muted);">Taper starts at ${Math.round(profile.taperStartSoc * 100)}% SoC (${profile.taperCurve})</span>`;
      }
    }

    async function plugInCar() {
      if (!plugCarTarget) return;
      const profileId = document.getElementById('plugCarProfile').value;
      const initialSoc = parseInt(document.getElementById('plugCarSoc').value) / 100;
      const result = await api(`/chargers/${plugCarTarget.cpId}/connectors/${plugCarTarget.connectorId}/plug-car`, {
        method: 'POST',
        body: JSON.stringify({ profileId, initialSoc })
      });
      if (result.success) {
        closePlugCarModal();
        showToast('EV plugged in', 'success');
        loadChargers();
        if (currentCharger && currentCharger.cpId === plugCarTarget.cpId) {
          setTimeout(() => openChargerPanel(plugCarTarget.cpId), 300);
        }
      } else {
        showToast(result.error || 'Failed to plug in car', 'error');
      }
    }

    async function unplugCar(cpId, connectorId) {
      const result = await api(`/chargers/${cpId}/connectors/${connectorId}/unplug-car`, { method: 'POST' });
      if (result.success) {
        showToast('EV unplugged', 'success');
        loadChargers();
        if (currentCharger && currentCharger.cpId === cpId) {
          setTimeout(() => openChargerPanel(cpId), 300);
        }
      } else {
        showToast(result.error || 'Failed to unplug car', 'error');
      }
    }

    function getSocBarClass(percent) {
      if (percent < 25) return 'low';
      if (percent < 70) return 'mid';
      return 'high';
    }

    // Toast
    function showToast(message, type = 'success') { const existing = document.querySelector('.toast'); if (existing) existing.remove(); const toast = document.createElement('div'); toast.className = `toast ${type}`; const icon = type === 'success' ? '<svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>' : '<svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>'; toast.innerHTML = icon + message; document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000); }

    // ========== PLUGCHOICE INTEGRATION ==========
    async function checkPlugchoiceToken() {
      try {
        const resp = await api('/plugchoice/token');
        hasPlugchoiceToken = resp.hasToken;
        document.getElementById('plugchoiceTokenStatus').textContent = hasPlugchoiceToken ? 'Token configured' : 'No token set';
        document.getElementById('plugchoiceTokenStatus').style.color = hasPlugchoiceToken ? 'var(--accent-green-dark)' : 'var(--text-muted)';
        if (hasPlugchoiceToken) loadChargerSiteMap();
      } catch(e) { hasPlugchoiceToken = false; }
    }

    async function savePlugchoiceToken() {
      const token = document.getElementById('plugchoiceTokenInput').value.trim();
      if (!token) { showToast('Please enter a token', 'error'); return; }
      await api('/plugchoice/token', { method: 'POST', body: JSON.stringify({ token }) });
      document.getElementById('plugchoiceTokenInput').value = '';
      showToast('Plugchoice token saved', 'success');
      checkPlugchoiceToken();
    }

    async function loadChargerSiteMap() {
      try {
        const teamChargers = await api('/plugchoice/team-chargers');
        chargerSiteMap = {};
        teamChargers.forEach(tc => {
          if (tc.site) {
            chargerSiteMap[tc.identity] = { siteName: tc.site.name, siteUuid: tc.site.uuid };
          }
        });
        renderTable();
      } catch(e) { console.log('Could not load Plugchoice charger map:', e); }
    }

    // ===== LOCATIONS PAGE =====
    let locSortColumn = 'name';
    let locSortDirection = 'asc';

    function sortLocations(column) {
      if (locSortColumn === column) {
        locSortDirection = locSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        locSortColumn = column;
        locSortDirection = 'asc';
      }
      renderLocations();
    }

    function updateLocSortIcons() {
      document.querySelectorAll('.loc-sort-icon').forEach(icon => {
        icon.classList.remove('asc', 'desc');
        if (icon.dataset.col === locSortColumn) {
          icon.classList.add(locSortDirection);
        }
      });
    }

    function populateLocationFilters() {
      const citySet = new Set(plugchoiceSites.map(s => s.city).filter(Boolean));
      const citySelect = document.getElementById('filterLocCity');
      const prev = citySelect.value;
      citySelect.innerHTML = '<option value="">All Cities</option>' +
        [...citySet].sort().map(c => `<option value="${c}">${c}</option>`).join('');
      citySelect.value = prev;
    }

    function resetLocationFilters() {
      document.getElementById('filterLocCity').value = '';
      document.getElementById('filterLocChargers').value = '';
      document.getElementById('locationSearchInput').value = '';
      renderLocations();
    }

    async function loadLocations() {
      if (!hasPlugchoiceToken) {
        document.getElementById('locationsTokenWarning').style.display = 'block';
        document.getElementById('locationsTableBody').innerHTML = '';
        document.getElementById('locationsTableEmpty').style.display = 'block';
        return;
      }
      document.getElementById('locationsTokenWarning').style.display = 'none';
      try {
        plugchoiceSites = await api('/plugchoice/sites');
        document.getElementById('locationCountBadge').textContent = plugchoiceSites.length;
        populateLocationFilters();
        renderLocations();
      } catch(e) { showToast('Failed to load locations', 'error'); }
    }

    function renderLocations() {
      const tbody = document.getElementById('locationsTableBody');
      const empty = document.getElementById('locationsTableEmpty');
      const search = document.getElementById('locationSearchInput').value.toLowerCase();
      const cityFilter = document.getElementById('filterLocCity').value;
      const chargersFilter = document.getElementById('filterLocChargers').value;

      let filtered = plugchoiceSites.filter(s => {
        if (search && !s.name.toLowerCase().includes(search) && !(s.city||'').toLowerCase().includes(search) && !(s.street||'').toLowerCase().includes(search) && !(s.postal_code||'').toLowerCase().includes(search)) return false;
        if (cityFilter && s.city !== cityFilter) return false;
        if (chargersFilter) {
          const cnt = s.chargers_count || 0;
          if (chargersFilter === '0' && cnt !== 0) return false;
          if (chargersFilter === '1-5' && (cnt < 1 || cnt > 5)) return false;
          if (chargersFilter === '6+' && cnt < 6) return false;
        }
        return true;
      });

      // Sort
      filtered.sort((a, b) => {
        let va = a[locSortColumn], vb = b[locSortColumn];
        if (locSortColumn === 'chargers_count' || locSortColumn === 'house_number') {
          va = va || 0; vb = vb || 0;
          return locSortDirection === 'asc' ? va - vb : vb - va;
        }
        va = (va || '').toString().toLowerCase();
        vb = (vb || '').toString().toLowerCase();
        const cmp = va.localeCompare(vb);
        return locSortDirection === 'asc' ? cmp : -cmp;
      });

      updateLocSortIcons();
      document.getElementById('locationFilterCount').textContent = `${filtered.length} / ${plugchoiceSites.length} locations`;
      if (filtered.length === 0) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      tbody.innerHTML = filtered.map(s => `<tr onclick="openLocationDetail('${s.uuid}')" style="cursor:pointer;">
        <td style="font-weight:600;">${s.name}</td>
        <td>${s.street || '-'}</td>
        <td>${s.house_number || '-'}</td>
        <td>${s.postal_code || '-'}</td>
        <td>${s.city || '-'}</td>
        <td>${s.chargers_count || 0}</td>
        <td><button class="action-btn" onclick="event.stopPropagation(); deleteLocation('${s.uuid}', '${s.name.replace(/'/g, "\\'")}')">Delete</button></td>
      </tr>`).join('');
    }

    async function deleteLocation(uuid, name) {
      if (!confirm(`Delete location "${name}"?`)) return;
      try {
        await api(`/plugchoice/sites/${uuid}`, { method: 'DELETE' });
        showToast(`Deleted ${name}`, 'success');
        loadLocations();
      } catch(e) { showToast('Failed to delete location', 'error'); }
    }

    // ===== LOCATION DETAIL =====
    let currentLocationUuid = null;

    function openLocationDetail(uuid) {
      currentLocationUuid = uuid;
      showPage('location-detail');
      loadLocationDetail(uuid);
    }

    async function loadLocationDetail(uuid) {
      try {
        const [site, chargers, cards] = await Promise.all([
          api(`/plugchoice/sites/${uuid}/detail`),
          api(`/plugchoice/sites/${uuid}/chargers-list`),
          api(`/plugchoice/sites/${uuid}/cards`),
        ]);

        document.getElementById('locDetailName').textContent = site.name || 'Unknown';
        const addr = [site.street, site.house_number, site.postal_code, site.city].filter(Boolean).join(', ');
        document.getElementById('locDetailAddress').textContent = addr || 'No address';

        const createdDate = site.created_at ? new Date(site.created_at).toLocaleDateString() : '-';
        document.getElementById('locDetailOverview').innerHTML = [
          { label: 'City', value: site.city || '-' },
          { label: 'Postal Code', value: site.postal_code || '-' },
          { label: 'Country', value: site.country || '-' },
          { label: 'Chargers', value: chargers.length },
          { label: 'Cards', value: cards.length },
          { label: 'Created', value: createdDate },
        ].map(i => `<div class="info-item"><div class="info-label">${i.label}</div><div class="info-value">${i.value}</div></div>`).join('');

        renderLocationChargers(chargers);
        renderLocationCards(cards);
      } catch (e) {
        showToast('Failed to load location details', 'error');
        console.error(e);
      }
    }

    function renderLocationChargers(chargers) {
      const tbody = document.getElementById('locDetailChargersBody');
      const empty = document.getElementById('locDetailChargersEmpty');
      document.getElementById('locDetailChargerCount').textContent = `${chargers.length} charger${chargers.length !== 1 ? 's' : ''}`;
      if (chargers.length === 0) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      tbody.innerHTML = chargers.map(ch => {
        const online = ch.connectivity_status === 'online';
        const statusLabel = ch.connectivity_status || 'unknown';
        const lastSeen = ch.last_seen_at ? new Date(ch.last_seen_at).toLocaleString() : '-';
        return `<tr>
          <td style="font-weight:600;">${ch.identity || '-'}</td>
          <td><span class="status-badge ${online ? 'Available' : 'Unavailable'}"><span class="status-badge-dot"></span>${statusLabel}</span></td>
          <td>${ch.firmware_version || '-'}</td>
          <td>${lastSeen}</td>
        </tr>`;
      }).join('');
    }

    function renderLocationCards(cards) {
      const tbody = document.getElementById('locDetailCardsBody');
      const empty = document.getElementById('locDetailCardsEmpty');
      document.getElementById('locDetailCardCount').textContent = `${cards.length} card${cards.length !== 1 ? 's' : ''}`;
      if (cards.length === 0) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      tbody.innerHTML = cards.map(card => {
        const created = card.created_at ? new Date(card.created_at).toLocaleDateString() : '-';
        return `<tr>
          <td style="font-weight:600;">${card.name || '-'}</td>
          <td><code style="background:var(--bg-secondary); padding:2px 8px; border-radius:4px; font-size:13px; cursor:pointer; user-select:all;" onclick="navigator.clipboard.writeText('${card.id_token || ''}'); showToast('Copied UID', 'success')">${card.id_token || '-'}</code></td>
          <td>${created}</td>
        </tr>`;
      }).join('');
    }

    function refreshLocationDetail() {
      if (currentLocationUuid) loadLocationDetail(currentLocationUuid);
    }

    // ===== CARD GENERATION HELPERS =====
    const CARD_NAME_POOL = [
      "Card 1","Card 2","Card 3","Card 4","Card 5",
      "Frank's card","Anna's tag","Jan's keyfob","Sophie's card","Emma's badge",
      "Keyfob Black","Keyfob White","Keyfob Blue","Keyfob Red","Keyfob Green",
      "Company card","Office badge","Door fob","Visitor pass","Reception card",
      "Fleet card A","Fleet card B","Service tag","Main entrance","Parking fob",
      "EV charge card","Technician fob","Manager's card","Night shift card","Backup key"
    ];

    function generateMifareUid() {
      const hex = '0123456789ABCDEF';
      let uid = '';
      for (let i = 0; i < 8; i++) uid += hex[Math.floor(Math.random() * 16)];
      return uid;
    }

    function pickRandomCards(count) {
      const shuffled = [...CARD_NAME_POOL].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, count).map(name => ({ name, id_token: generateMifareUid() }));
    }

    // ===== GENERATE LOCATIONS =====
    function showGenerateLocationsModal() {
      if (!hasPlugchoiceToken) { showToast('Configure Plugchoice token in Settings first', 'error'); return; }
      document.getElementById('generateLocationsModal').classList.add('show');
      document.getElementById('genLocProgress').style.display = 'none';
      document.getElementById('genLocBtn').disabled = false;
    }
    function closeGenerateLocationsModal() { document.getElementById('generateLocationsModal').classList.remove('show'); }

    function generateRandomLocation() {
      const prefixes = ['AURA','BOLT','CARS','FARO','GARA','INST','KITE','LUMA','MINT','NOVA','OVAL','PILO','RIVR','SOLA','TIDE','VIVA','APEX','FLUX','GRID','VOLT','WAVE','ZEST','PEAK','CORE','DOME','EDGE','HIVE','LYNX','NEON','RUBY'];
      const surnames = ['Bakker','Visser','Meijer','De Vries','Jansen','Peters','Hendriks','De Boer','Dekker','Mulder','Schouten','Van Dijk','Van den Berg','Van der Wal','Van der Linden','Verhoeven','Kramer','Van Leeuwen','Vos','Van Dam','Van Vliet','De Groot','Smit','Brouwer','Van der Heijden','Kuijpers','Willems','Bos','Van der Meer','Vermeer'];
      const streetParts1 = ['Akker','Baan','Beuken','Bos','Eiken','Erasmus','Haven','Heuvel','Hoek','Juliana','Kade','Kastanje','Kerk','Konings','Koren','Linde','Markt','Molen','Ooster','Prinsen','Rembrandt','School','Singel','Spui','Veld','Vondel','Wald','Weide','Wester','Zilver','Dam','Dijk','Park','Rijn','Maas','Waal'];
      const streetParts2 = ['hof','laan','dreef','singel','plantsoen','park','straat','weg','gracht','kade','pad','steeg','plein','boulevard'];
      const useTwoParts = Math.random() > 0.4;
      const street = useTwoParts ? streetParts1[Math.floor(Math.random()*streetParts1.length)] + ' ' + streetParts2[Math.floor(Math.random()*streetParts2.length)] : streetParts1[Math.floor(Math.random()*streetParts1.length)] + streetParts2[Math.floor(Math.random()*streetParts2.length)];
      const houseNum = Math.floor(Math.random() * 180) + 1;
      // Cities with weighted distribution (more Randstad)
      const cities = [
        {city:'Amsterdam',pc:'10'},{city:'Amsterdam',pc:'10'},{city:'Amsterdam',pc:'10'},
        {city:'Rotterdam',pc:'30'},{city:'Rotterdam',pc:'30'},
        {city:'Den Haag',pc:'25'},{city:'Den Haag',pc:'25'},
        {city:'Utrecht',pc:'35'},{city:'Utrecht',pc:'35'},{city:'Utrecht',pc:'35'},
        {city:'Haarlem',pc:'20'},{city:'Delft',pc:'26'},
        {city:'Leiden',pc:'23'},{city:'Zoetermeer',pc:'27'},
        {city:'Hoofddorp',pc:'21'},{city:'Almere',pc:'13'},
        {city:'Zaandam',pc:'15'},{city:'Gouda',pc:'28'},
        {city:'Tilburg',pc:'50'},{city:'Den Bosch',pc:'52'},
        {city:'Eindhoven',pc:'56'},{city:'Helmond',pc:'57'},
        {city:'Breda',pc:'48'},{city:'Middelburg',pc:'43'},
        {city:'Vlissingen',pc:'43'},{city:'Apeldoorn',pc:'73'},
        {city:'Deventer',pc:'74'},{city:'Enschede',pc:'75'},
        {city:'Groningen',pc:'97'},{city:'Leeuwarden',pc:'89'},
        {city:'Emmen',pc:'78'},{city:'Sittard',pc:'61'},
        {city:'Heerlen',pc:'64'},{city:'Maastricht',pc:'62'},
        {city:'Alkmaar',pc:'18'},{city:'Arnhem',pc:'68'},
      ];
      const cityObj = cities[Math.floor(Math.random()*cities.length)];
      const pcNum = parseInt(cityObj.pc) * 100 + Math.floor(Math.random()*99) + 1;
      const pcLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const postalCode = `${pcNum} ${pcLetters[Math.floor(Math.random()*26)]}${pcLetters[Math.floor(Math.random()*26)]}`;
      const prefix = prefixes[Math.floor(Math.random()*prefixes.length)];
      const projNum = String(Math.floor(Math.random()*10000)).padStart(4,'0');
      const surname = surnames[Math.floor(Math.random()*surnames.length)];
      const name = `${prefix}-${projNum}-${surname}`;
      return { name, street, house_number: houseNum, postal_code: postalCode, city: cityObj.city, country: 'NL' };
    }

    async function executeGenerateLocations() {
      const count = parseInt(document.getElementById('generateLocationsCount').value) || 10;
      document.getElementById('genLocProgress').style.display = 'block';
      document.getElementById('genLocBtn').disabled = true;
      let success = 0;
      for (let i = 0; i < count; i++) {
        const loc = generateRandomLocation();
        try {
          const result = await api('/plugchoice/sites', { method: 'POST', body: JSON.stringify(loc) });
          success++;
          // Auto-generate 3-5 RFID cards for the new site
          const siteUuid = result.data?.uuid || result.uuid;
          if (siteUuid) {
            const cardCount = 3 + Math.floor(Math.random() * 3);
            const cards = pickRandomCards(cardCount);
            for (const card of cards) {
              try {
                await api(`/plugchoice/sites/${siteUuid}/cards`, { method: 'POST', body: JSON.stringify(card) });
              } catch(e) { console.error('Failed to create card:', e); }
            }
          }
        } catch(e) { console.error('Failed to create location:', e); }
        const pct = Math.round(((i+1)/count)*100);
        document.getElementById('genLocProgressBar').style.width = pct + '%';
        document.getElementById('genLocProgressText').textContent = `Creating... ${i+1}/${count} (+ cards)`;
      }
      document.getElementById('genLocBtn').disabled = false;
      showToast(`Created ${success} location(s) with cards`, 'success');
      closeGenerateLocationsModal();
      loadLocations();
    }

    // ===== ATTACH TO LOCATION =====
    async function showAttachLocationModal() {
      if (!hasPlugchoiceToken) { showToast('Configure Plugchoice token in Settings first', 'error'); return; }
      document.getElementById('attachLocationCount').textContent = selectedChargers.size;
      document.getElementById('attachLocationProgress').style.display = 'none';
      document.getElementById('attachLocationBtn').disabled = false;
      if (plugchoiceSites.length === 0) {
        try { plugchoiceSites = await api('/plugchoice/sites'); } catch(e) {}
      }
      // Reset search state
      document.getElementById('attachLocSearchInput').value = '';
      document.getElementById('attachLocationSelect').value = '_random';
      document.getElementById('attachLocSelected').textContent = 'Random locations';
      document.getElementById('attachLocSelected').style.color = 'var(--accent-green)';
      document.getElementById('attachLocationModal').classList.add('show');
      filterAttachLocList();
    }
    function closeAttachLocationModal() {
      document.getElementById('attachLocationModal').classList.remove('show');
      document.getElementById('attachLocDropdown').style.display = 'none';
    }

    function showAttachLocDropdown() {
      filterAttachLocList();
      document.getElementById('attachLocDropdown').style.display = 'block';
    }

    function filterAttachLocList() {
      const query = document.getElementById('attachLocSearchInput').value.toLowerCase();
      const dropdown = document.getElementById('attachLocDropdown');
      const itemStyle = 'padding:8px 12px; cursor:pointer; font-size:13px; border-bottom:1px solid var(--border-light); transition:background 0.1s;';
      const hoverAttr = 'onmouseenter="this.style.background=\'var(--bg-hover)\'" onmouseleave="this.style.background=\'transparent\'"';

      let html = `<div style="${itemStyle} font-weight:600; color:var(--accent-green);" ${hoverAttr} onclick="selectAttachLoc('_random', 'Random locations')">Assign to random locations</div>`;
      const matches = plugchoiceSites.filter(s =>
        !query || s.name.toLowerCase().includes(query) || (s.city||'').toLowerCase().includes(query) || (s.street||'').toLowerCase().includes(query)
      );
      for (const s of matches) {
        const label = `${s.name} — ${s.city || ''}`;
        const escapedLabel = label.replace(/'/g, "\\'");
        html += `<div style="${itemStyle}" ${hoverAttr} onclick="selectAttachLoc('${s.uuid}', '${escapedLabel}')">
          <div style="font-weight:500;">${s.name}</div>
          <div style="font-size:11px; color:var(--text-muted);">${s.street || ''} ${s.house_number || ''}, ${s.city || ''}</div>
        </div>`;
      }
      if (matches.length === 0 && query) {
        html += `<div style="${itemStyle} color:var(--text-muted); font-style:italic;">No locations found</div>`;
      }
      dropdown.innerHTML = html;
      dropdown.style.display = 'block';
    }

    function selectAttachLoc(uuid, label) {
      document.getElementById('attachLocationSelect').value = uuid;
      document.getElementById('attachLocSelected').textContent = label;
      document.getElementById('attachLocSelected').style.color = uuid === '_random' ? 'var(--accent-green)' : 'var(--text-primary)';
      document.getElementById('attachLocSearchInput').value = '';
      document.getElementById('attachLocDropdown').style.display = 'none';
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const wrap = document.getElementById('attachLocSearchWrap');
      if (wrap && !wrap.contains(e.target)) {
        document.getElementById('attachLocDropdown').style.display = 'none';
      }
    });

    async function executeAttachLocation() {
      const siteUuid = document.getElementById('attachLocationSelect').value;
      const identities = [...selectedChargers];
      document.getElementById('attachLocationProgress').style.display = 'block';
      document.getElementById('attachLocationBtn').disabled = true;
      let success = 0, fail = 0;
      if (siteUuid === '_random') {
        // Assign each charger to a random site
        const availableSites = plugchoiceSites.length > 0 ? plugchoiceSites : [];
        if (availableSites.length === 0) { showToast('No locations available', 'error'); return; }
        for (let i = 0; i < identities.length; i++) {
          const site = availableSites[Math.floor(Math.random() * availableSites.length)];
          try {
            const resp = await api(`/plugchoice/sites/${site.uuid}/chargers`, { method: 'POST', body: JSON.stringify({ identity: identities[i] }) });
            if (resp.error) { fail++; } else { success++; }
          } catch(e) { fail++; }
          const pct = Math.round(((i+1)/identities.length)*100);
          document.getElementById('attachLocationProgressBar').style.width = pct + '%';
          document.getElementById('attachLocationProgressText').textContent = `Attaching... ${i+1}/${identities.length}`;
        }
      } else {
        // Assign all to one specific site
        for (let i = 0; i < identities.length; i++) {
          try {
            const resp = await api(`/plugchoice/sites/${siteUuid}/chargers`, { method: 'POST', body: JSON.stringify({ identity: identities[i] }) });
            if (resp.error) { fail++; } else { success++; }
          } catch(e) { fail++; }
          const pct = Math.round(((i+1)/identities.length)*100);
          document.getElementById('attachLocationProgressBar').style.width = pct + '%';
          document.getElementById('attachLocationProgressText').textContent = `Attaching... ${i+1}/${identities.length}`;
        }
      }
      document.getElementById('attachLocationBtn').disabled = false;
      showToast(`Attached ${success} charger(s)${fail > 0 ? `, ${fail} failed` : ''}`, success > 0 ? 'success' : 'error');
      closeAttachLocationModal();
      loadChargerSiteMap();
      loadLocations();
    }

  </script>
</body>
</html>
